AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: OCR to Bedrock Knowledge Base Pipeline

Parameters:
  DeploymentSuffix:
    Type: String
    Description: Unique suffix for this deployment (generated by publish.py)
    MinLength: 5
    MaxLength: 5
    AllowedPattern: '^[a-z0-9]{5}$'
    ConstraintDescription: Must be exactly 5 lowercase alphanumeric characters

  ProjectName:
    Type: String
    Description: Project name for resource identification (lowercase alphanumeric + hyphens, 2-32 chars)
    AllowedPattern: '^[a-z][a-z0-9-]{1,31}$'
    ConstraintDescription: Must start with lowercase letter, contain only lowercase alphanumeric and hyphens, 2-32 chars
    MinLength: 2
    MaxLength: 32

  OcrBackend:
    Type: String
    Default: textract
    AllowedValues:
      - textract
      - bedrock
    Description: OCR backend to use (textract or bedrock)

  BedrockOcrModelId:
    Type: String
    Default: meta.llama3-2-90b-instruct-v1:0
    Description: Bedrock model ID for OCR (if backend=bedrock)
    AllowedValues:
      - meta.llama3-2-90b-instruct-v1:0
      - meta.llama3-2-11b-instruct-v1:0
      - us.anthropic.claude-sonnet-4-20250514-v1:0
      - us.anthropic.claude-haiku-4-5-20251001-v1:0
    ConstraintDescription: Must be a valid Bedrock vision-capable model ID

  UISourceBucket:
    Type: String
    Description: S3 bucket containing UI source code zip
    Default: ''

  UISourceKey:
    Type: String
    Description: S3 key for UI source code zip
    Default: ''

  WebComponentSourceKey:
    Type: String
    Description: S3 key for web component source code zip
    Default: ''

  AdminEmail:
    Type: String
    Description: Admin email for Cognito user and CloudWatch/budget alerts
    AllowedPattern: '^[\w.+-]+@([\w-]+\.)+[\w-]{2,6}$'
    ConstraintDescription: Must be a valid email address

Globals:
  Function:
    Runtime: python3.13
    Timeout: 900  # 15 minutes
    MemorySize: 2048
    Environment:
      Variables:
        LOG_LEVEL: INFO

Conditions:
  BuildUI: !Not [!Equals [!Ref UISourceBucket, '']]

Resources:
  # =========================================================================
  # S3 Buckets
  # =========================================================================

  InputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-input-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupIncompleteUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - PUT
              - POST
              - GET
              - HEAD
            AllowedOrigins:
              - 'http://localhost:5173'
              - 'http://localhost:3000'
              - !Sub 'https://${CloudFrontDistribution.DomainName}'
            MaxAge: 3000
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  OutputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-output-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldOutputs
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - HEAD
            AllowedOrigins:
              - !Sub 'https://${CloudFrontDistribution.DomainName}'
            MaxAge: 3000
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  WorkingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-working-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteWorkingFiles
            Status: Enabled
            ExpirationInDays: 7
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  VectorBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-vectors-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldVectors
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  # =========================================================================
  # CodeBuild Resources for UI Deployment
  # =========================================================================

  UICodeBuildServiceRole:
    Type: AWS::IAM::Role
    Condition: BuildUI
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub 'codebuild.${AWS::URLSuffix}'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildUIPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 read access for UI source artifacts
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}'
              # S3 write access for UI deployment bucket
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub '${UIBucket.Arn}'
                  - !Sub '${UIBucket.Arn}/*'
              # CloudFront invalidation
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                Resource: !Sub 'arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'
              # CloudFormation read access for outputs
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                Resource: !Ref AWS::StackId
              # EventBridge rule creation
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:PutTargets
                  - events:RemoveTargets
                  - events:DeleteRule
                Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*'
              # Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  UICodeBuildProject:
    Type: AWS::CodeBuild::Project
    Condition: BuildUI
    Properties:
      Name: !Sub '${AWS::StackName}-webui-build-${DeploymentSuffix}'
      Description: !Sub 'Web UI build for ${AWS::StackName}'
      ServiceRole: !GetAtt UICodeBuildServiceRole.Arn
      EncryptionKey: alias/aws/s3
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: S3
        Location: !Sub '${UISourceBucket}/${UISourceKey}'
        BuildSpec: |
          version: 0.2
          phases:
            pre_build:
              commands:
                - echo "Installing dependencies..."
                - cd ui
                - npm install
            build:
              commands:
                - echo "Building React application..."
                - npm run build
            post_build:
              commands:
                - echo "Deploying to S3..."
                - aws s3 sync dist/ s3://${UI_BUCKET}/ --delete
                - echo "Invalidating CloudFront cache..."
                - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DIST_ID} --paths "/*"
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
          - Name: VITE_AWS_REGION
            Value: !Ref AWS::Region
          - Name: VITE_USER_POOL_ID
            Value: !Ref UserPool
          - Name: VITE_USER_POOL_CLIENT_ID
            Value: !Ref UserPoolClient
          - Name: VITE_IDENTITY_POOL_ID
            Value: !Ref IdentityPool
          - Name: VITE_GRAPHQL_URL
            Value: !GetAtt GraphQLApi.GraphQLUrl
          - Name: VITE_INPUT_BUCKET
            Value: !Ref InputBucket
          - Name: UI_BUCKET
            Value: !Ref UIBucket
          - Name: CLOUDFRONT_DIST_ID
            Value: !Ref CloudFrontDistribution
      TimeoutInMinutes: 30

  # =========================================================================
  # UI S3 Bucket
  # =========================================================================

  UIBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-ui-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: false  # CloudFront needs access
        IgnorePublicAcls: true
        RestrictPublicBuckets: false
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  # =========================================================================
  # CloudFront Distribution for UI
  # =========================================================================

  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub 'OAI for ${ProjectName} UI'

  UIBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref UIBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub '${UIBucket.Arn}/*'

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub '${ProjectName} UI Distribution'
        DefaultRootObject: index.html
        HttpVersion: http2
        PriceClass: PriceClass_100  # Use only North America and Europe

        Origins:
          - Id: S3Origin
            DomainName: !GetAtt UIBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}'

        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none

        # Custom error pages for SPA routing
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300

        ViewerCertificate:
          CloudFrontDefaultCertificate: true
          # For custom domain, use ACM certificate:
          # AcmCertificateArn: !Ref CertificateArn
          # SslSupportMethod: sni-only
          # MinimumProtocolVersion: TLSv1.2_2021

  # =========================================================================
  # Web Component CDN Infrastructure
  # =========================================================================

  WebComponentAssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-wc-assets-${DeploymentSuffix}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: false  # Allow CloudFront OAI bucket policy
        IgnorePublicAcls: true
        RestrictPublicBuckets: false  # Allow CloudFront OAI access
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  WebComponentOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub 'OAI for ${ProjectName} web component CDN'

  WebComponentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebComponentAssetsBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt WebComponentOriginAccessIdentity.S3CanonicalUserId
            Action: 's3:GetObject'
            Resource: !Sub '${WebComponentAssetsBucket.Arn}/*'

  WebComponentCORSPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: !Sub '${ProjectName}-wc-cors-${DeploymentSuffix}'
        Comment: CORS policy for web component CDN
        CorsConfig:
          AccessControlAllowOrigins:
            Items:
              - '*'
          AccessControlAllowHeaders:
            Items:
              - '*'
          AccessControlAllowMethods:
            Items:
              - GET
              - HEAD
              - OPTIONS
          AccessControlAllowCredentials: false
          OriginOverride: true

  WebComponentDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub 'CDN for ${ProjectName} web component'
        DefaultRootObject: 'amplify-chat.js'
        Origins:
          - Id: WebComponentS3Origin
            DomainName: !GetAtt WebComponentAssetsBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${WebComponentOriginAccessIdentity}'
        DefaultCacheBehavior:
          TargetOriginId: WebComponentS3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized managed policy
          ResponseHeadersPolicyId: !Ref WebComponentCORSPolicy
        HttpVersion: http2
        PriceClass: PriceClass_100
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  WebComponentBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/CloudWatchLogsFullAccess'
      Policies:
        - PolicyName: WebComponentBuildPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 access for web component assets bucket
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt WebComponentAssetsBucket.Arn
                  - !Sub '${WebComponentAssetsBucket.Arn}/*'
              # CloudFront invalidation
              - Effect: Allow
                Action:
                  - 'cloudfront:CreateInvalidation'
                Resource: !Sub 'arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/${WebComponentDistribution}'
              # S3 access for source artifacts
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:ListBucket'
                Resource:
                  - !Sub 'arn:aws:s3:::${ProjectName}-artifacts-*'
                  - !Sub 'arn:aws:s3:::${ProjectName}-artifacts-*/*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  WebComponentBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ProjectName}-wc-build-${DeploymentSuffix}'
      Description: Build and deploy web component to CDN
      ServiceRole: !GetAtt WebComponentBuildRole.Arn
      EncryptionKey: alias/aws/s3
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: S3
        Location: !Sub '${UISourceBucket}/${WebComponentSourceKey}'
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                nodejs: 24
              commands:
                - echo "Installing dependencies..."
                - cd src/amplify-chat
                - npm ci
            pre_build:
              commands:
                - echo "Downloading Amplify outputs from S3..."
                - aws s3 cp s3://${ARTIFACT_BUCKET}/amplify_outputs.json ../../amplify_outputs.json
                - echo "âœ“ amplify_outputs.json downloaded successfully"
                - ls -lh ../../amplify_outputs.json
            build:
              commands:
                - echo "Building web component..."
                - npm run build:wc
                - ls -lh dist/
            post_build:
              commands:
                - echo "Deploying to S3..."
                - aws s3 cp dist/wc.js s3://${ASSET_BUCKET}/amplify-chat.js --content-type application/javascript --cache-control "public, max-age=31536000"
                - aws s3 cp dist/wc.esm.js s3://${ASSET_BUCKET}/amplify-chat.esm.js --content-type application/javascript --cache-control "public, max-age=31536000"
                - echo "Invalidating CloudFront cache..."
                - aws cloudfront create-invalidation --distribution-id ${DISTRIBUTION_ID} --paths "/amplify-chat.js" "/amplify-chat.esm.js"
                - echo "Deployment complete!"
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
          - Name: ASSET_BUCKET
            Value: !Ref WebComponentAssetsBucket
          - Name: DISTRIBUTION_ID
            Value: !Ref WebComponentDistribution
          - Name: ARTIFACT_BUCKET
            Value: !Ref UISourceBucket
      TimeoutInMinutes: 15
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # =========================================================================
  # DynamoDB Tables
  # =========================================================================

  TrackingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-tracking-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: document_id
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: document_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CreatedAtIndex
          KeySchema:
            - AttributeName: created_at
              KeyType: HASH
            - AttributeName: document_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  MeteringTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-metering-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: document_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: document_id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      TimeToLiveSpecification:
        Enabled: true
        AttributeName: ttl
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  ##########################################################################
  # Configuration Table - Runtime configurable parameters
  ##########################################################################

  ConfigurationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-config-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: Configuration
          AttributeType: S
      KeySchema:
        - AttributeName: Configuration
          KeyType: HASH
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: Runtime Configuration Storage

  # =========================================================================
  # Lambda Layers
  # =========================================================================

  RagstackCommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub '${ProjectName}-Common'
      Description: Shared utilities for Lambda functions
      ContentUri: lib/
      CompatibleRuntimes:
        - python3.13
    Metadata:
      BuildMethod: python3.13

  # =========================================================================
  # Lambda Functions
  # =========================================================================

  ProcessDocumentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-process-${DeploymentSuffix}'
      CodeUri: src/lambda/process_document/
      Handler: index.lambda_handler
      Description: Process document - OCR and text extraction
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 900  # 15 minutes for large documents
      MemorySize: 3008  # Max memory for OCR processing
      Tracing: Active
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt ProcessingDLQ.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          TRACKING_TABLE: !Ref TrackingTable
          METERING_TABLE: !Ref MeteringTable
          OUTPUT_BUCKET: !Ref OutputBucket
          WORKING_BUCKET: !Ref WorkingBucket
          OCR_BACKEND: !Ref OcrBackend
          BEDROCK_OCR_MODEL_ID: !Ref BedrockOcrModelId
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3CrudPolicy:
            BucketName: !Ref WorkingBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MeteringTable
        - DynamoDBReadPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
            - Effect: Allow
              Action:
                - textract:DetectDocumentText
                - textract:AnalyzeDocument
              Resource: '*'
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:*::foundation-model/*'
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'

  IngestToKBFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-ingest-${DeploymentSuffix}'
      CodeUri: src/lambda/ingest_to_kb/
      Handler: index.lambda_handler
      Description: Ingest documents directly into Knowledge Base
      Runtime: python3.13
      Timeout: 300
      MemorySize: 256
      Tracing: Active
      Environment:
        Variables:
          LOG_LEVEL: INFO
          KNOWLEDGE_BASE_ID: !GetAtt KnowledgeBase.KnowledgeBaseId
          DATA_SOURCE_ID: !GetAtt KnowledgeBase.DataSourceId
          TRACKING_TABLE: !Ref TrackingTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:IngestKnowledgeBaseDocuments
                - bedrock:StartIngestionJob
                - bedrock:GetKnowledgeBase
                - bedrock:GetDataSource
                - bedrock:ListDataSources
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
            - Effect: Allow
              Action:
                - bedrock:StartIngestionJob
                - bedrock:GetIngestionJob
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*/data-source/*'

  QueryKBFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-query-${DeploymentSuffix}'
      CodeUri: src/lambda/query_kb/
      Handler: index.lambda_handler
      Description: Query Bedrock Knowledge Base
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 60
      MemorySize: 512
      Tracing: Active
      Environment:
        Variables:
          LOG_LEVEL: INFO
          KNOWLEDGE_BASE_ID: !GetAtt KnowledgeBase.KnowledgeBaseId
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:RetrieveAndGenerate
              Resource: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:*::foundation-model/*'
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'
            - Effect: Allow
              Action: bedrock:GetInferenceProfile
              Resource: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'

  ##########################################################################
  # Configuration Resolver Lambda
  ##########################################################################

  ConfigurationResolverFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-config-${DeploymentSuffix}'
      CodeUri: src/lambda/configuration_resolver/
      Handler: index.lambda_handler
      Description: GraphQL resolver for configuration management
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
          TRACKING_TABLE: !Ref TrackingTable
          STATE_MACHINE_ARN: !Ref ProcessingStateMachine
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource: !GetAtt ConfigurationTable.Arn
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:Query
              Resource:
                - !GetAtt TrackingTable.Arn
                - !Sub '${TrackingTable.Arn}/index/StatusIndex'
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref ProcessingStateMachine

  # =========================================================================
  # Step Functions State Machine
  # =========================================================================

  StateMachineExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambdas
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt ProcessDocumentFunction.Arn
                  - !GetAtt IngestToKBFunction.Arn
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutLogEvents
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: '*'

  ProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub '${ProjectName}-ProcessingPipeline'
      DefinitionUri: src/statemachine/pipeline.asl.json
      DefinitionSubstitutions:
        ProcessDocumentFunctionArn: !GetAtt ProcessDocumentFunction.Arn
        IngestToKBFunctionArn: !GetAtt IngestToKBFunction.Arn
      Role: !GetAtt StateMachineExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogGroup.Arn

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vendedlogs/states/${ProjectName}-Pipeline'
      RetentionInDays: 30

  # =========================================================================
  # EventBridge Rule for S3 Upload Trigger
  # =========================================================================

  S3UploadRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-S3UploadTrigger'
      Description: Trigger processing pipeline on S3 upload
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        detail:
          bucket:
            name:
              - !Ref InputBucket
      State: ENABLED
      Targets:
        - Arn: !GetAtt ProcessingStateMachine.Arn
          RoleArn: !GetAtt EventBridgeToStepFunctionsRole.Arn
          Id: TriggerProcessing
          InputTransformer:
            InputPathsMap:
              bucket: $.detail.bucket.name
              key: $.detail.object.key
            InputTemplate: !Sub |
              {
                "document_id": "<key>",
                "input_s3_uri": "s3://<bucket>/<key>",
                "output_s3_prefix": "s3://${OutputBucket}/<key>/",
                "vector_bucket": "${VectorBucket}"
              }
          RetryPolicy:
            MaximumRetryAttempts: 2

  EventBridgeToStepFunctionsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StartExecution
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource: !GetAtt ProcessingStateMachine.Arn

  # =========================================================================
  # Bedrock Knowledge Base
  # =========================================================================

  KnowledgeBaseRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                'aws:SourceAccount': !Ref AWS::AccountId
              ArnLike:
                'aws:SourceArn': !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
      Policies:
        - PolicyName: S3DataSourceAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${OutputBucket.Arn}'
                  - !Sub '${OutputBucket.Arn}/*'
        - PolicyName: S3VectorsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${VectorBucket.Arn}'
                  - !Sub '${VectorBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3vectors:DescribeIndex
                  - s3vectors:ReadVectors
                  - s3vectors:WriteVectors
                  - s3vectors:PutVectors
                  - s3vectors:QueryVectors
                  - s3vectors:GetVectors
                  - s3vectors:DeleteVectors
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}'
                  - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}/*'
        - PolicyName: BedrockModelAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v2:0'

  KnowledgeBaseCustomResourceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-kb-init-${DeploymentSuffix}'
      CodeUri: src/lambda/kb_custom_resource/
      Handler: index.lambda_handler
      Description: Custom resource for Knowledge Base creation with S3 Vectors
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:CreateKnowledgeBase
                - bedrock:DeleteKnowledgeBase
                - bedrock:GetKnowledgeBase
                - bedrock:UpdateKnowledgeBase
                - bedrock:ListKnowledgeBases
                - bedrock:CreateDataSource
                - bedrock:DeleteDataSource
                - bedrock:GetDataSource
                - bedrock:ListDataSources
                - bedrock-agent:CreateKnowledgeBase
                - bedrock-agent:DeleteKnowledgeBase
                - bedrock-agent:GetKnowledgeBase
                - bedrock-agent:UpdateKnowledgeBase
                - bedrock-agent:ListKnowledgeBases
                - bedrock-agent:CreateDataSource
                - bedrock-agent:DeleteDataSource
                - bedrock-agent:GetDataSource
                - bedrock-agent:ListDataSources
              Resource: '*'
            - Effect: Allow
              Action:
                - s3vectors:CreateVectorBucket
                - s3vectors:GetVectorBucket
                - s3vectors:CreateIndex
                - s3vectors:DeleteIndex
                - s3vectors:DescribeIndex
                - s3vectors:ListIndices
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}'
                - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}/*'
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt KnowledgeBaseRole.Arn
            - Effect: Allow
              Action:
                - ssm:PutParameter
                - ssm:DeleteParameter
                - ssm:GetParameter
              Resource: !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/KnowledgeBaseId'

  KnowledgeBase:
    Type: Custom::KnowledgeBase
    Properties:
      ServiceToken: !GetAtt KnowledgeBaseCustomResourceFunction.Arn
      KnowledgeBaseName: !Sub '${ProjectName}-kb-${DeploymentSuffix}'
      RoleArn: !GetAtt KnowledgeBaseRole.Arn
      VectorBucket: !Ref VectorBucket
      OutputBucket: !Ref OutputBucket
      EmbedModelArn: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v2:0'
      IndexName: !Sub '${ProjectName}-index-${DeploymentSuffix}'
      Region: !Ref AWS::Region
      ProjectName: !Ref ProjectName

  # =========================================================================
  # Cognito Authentication
  # =========================================================================

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${ProjectName}-Users'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${ProjectName}-WebClient'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub '${ProjectName}Identity'
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      Policies:
        - PolicyName: AuthenticatedAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource:
                  - !Sub '${InputBucket.Arn}/*'
                  - !Sub '${OutputBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - appsync:GraphQL
                Resource:
                  - !Sub '${GraphQLApi.Arn}/*'

  AdminUser:
    Type: AWS::Cognito::UserPoolUser
    Properties:
      UserPoolId: !Ref UserPool
      Username: !Ref AdminEmail
      UserAttributes:
        - Name: email
          Value: !Ref AdminEmail
        - Name: email_verified
          Value: 'true'
      DesiredDeliveryMediums:
        - EMAIL

  # =========================================================================
  # AppSync GraphQL API
  # =========================================================================

  GraphQLApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub '${ProjectName}-API'
      AuthenticationType: AMAZON_COGNITO_USER_POOLS
      UserPoolConfig:
        UserPoolId: !Ref UserPool
        AwsRegion: !Ref AWS::Region
        DefaultAction: ALLOW
      LogConfig:
        CloudWatchLogsRoleArn: !GetAtt AppSyncLogsRole.Arn
        FieldLogLevel: ERROR

  GraphQLSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      DefinitionS3Location: ./src/api/schema.graphql

  AppSyncLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs

  # AppSync resolver Lambda
  AppSyncResolverFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-appsync-${DeploymentSuffix}'
      CodeUri: src/lambda/appsync_resolvers/
      Handler: index.lambda_handler
      Layers:
        - !Ref RagstackCommonLayer
      Tracing: Active
      Environment:
        Variables:
          TRACKING_TABLE: !Ref TrackingTable
          INPUT_BUCKET: !Ref InputBucket
          STATE_MACHINE_ARN: !GetAtt ProcessingStateMachine.Arn
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3CrudPolicy:
            BucketName: !Ref InputBucket
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !GetAtt ProcessingStateMachine.Arn

  StartUICodeBuild:
    Type: AWS::Serverless::Function
    Condition: BuildUI
    Properties:
      FunctionName: !Sub '${ProjectName}-ui-builder-${DeploymentSuffix}'
      CodeUri: src/lambda/start_codebuild/
      Handler: index.lambda_handler
      Description: Custom resource to trigger UI CodeBuild project
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 300  # 5 minutes
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - codebuild:StartBuild
                - codebuild:BatchGetBuilds
              Resource: !GetAtt UICodeBuildProject.Arn
        - Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:DeleteRule
                - events:PutTargets
                - events:RemoveTargets
              Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*'
        - Statement:
            - Effect: Allow
              Action:
                - lambda:AddPermission
                - lambda:RemovePermission
              Resource: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-ui-builder-*'
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*'

  CodeBuildRun:
    Type: Custom::CodeBuildRun
    Condition: BuildUI
    Properties:
      ServiceToken: !GetAtt StartUICodeBuild.Arn
      BuildProjectName: !Ref UICodeBuildProject
      # Force rebuild when source changes
      UISourceLocation: !Sub 's3://${UISourceBucket}/${UISourceKey}'

  # Data source for resolvers
  AppSyncLambdaDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: LambdaDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AppSyncResolverFunction.Arn

  AppSyncLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambda
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt AppSyncResolverFunction.Arn
                  - !GetAtt QueryKBFunction.Arn
                  - !GetAtt ConfigurationResolverFunction.Arn

  # Data source for KB queries
  KBQueryDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: KBQueryDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt QueryKBFunction.Arn

  # Data source for Configuration Resolver
  ConfigurationResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: ConfigurationResolverDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ConfigurationResolverFunction.Arn

  # Resolvers
  GetDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getDocument
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  ListDocumentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: listDocuments
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  CreateUploadUrlResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: createUploadUrl
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  ProcessDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: processDocument
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  QueryKBResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: queryKnowledgeBase
      DataSourceName: !GetAtt KBQueryDataSource.Name

  # Configuration Resolvers
  GetConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getConfiguration
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  UpdateConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: updateConfiguration
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  # =========================================================================
  # Dead Letter Queue for Error Handling
  # =========================================================================

  ProcessingDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-Processing-DLQ'
      MessageRetentionPeriod: 1209600  # 14 days
      VisibilityTimeout: 300
      SqsManagedSseEnabled: true

  # =========================================================================
  # SNS Topic for Alarm Notifications
  # =========================================================================

  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-Alarms'
      DisplayName: !Sub '${ProjectName} CloudWatch Alarms'
      KmsMasterKeyId: alias/aws/sns
      Subscription:
        - Endpoint: !Ref AdminEmail
          Protocol: email

  # =========================================================================
  # CloudWatch Dashboard
  # =========================================================================

  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${ProjectName}-Monitor'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "ProcessDocument", "color": "#1f77b4"}],
                  ["...", {"stat": "Sum", "label": "QueryKB", "color": "#2ca02c"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Invocations",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", {"stat": "Sum", "label": "ProcessDocument Errors", "color": "#d62728"}],
                  ["...", {"stat": "Sum", "label": "QueryKB Errors", "color": "#e377c2"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Errors",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/States", "ExecutionsFailed", {"stat": "Sum", "color": "#d62728"}],
                  [".", "ExecutionsSucceeded", {"stat": "Sum", "color": "#2ca02c"}],
                  [".", "ExecutionsTimedOut", {"stat": "Sum", "color": "#ff7f0e"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Step Functions Executions"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", {"label": "DLQ Messages", "color": "#d62728"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Dead Letter Queue",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum", "color": "#1f77b4"}],
                  [".", "ConsumedWriteCapacityUnits", {"stat": "Sum", "color": "#ff7f0e"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Capacity"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", {"stat": "Average", "label": "ProcessDocument", "color": "#1f77b4"}],
                  ["...", {"stat": "Average", "label": "QueryKB", "color": "#2ca02c"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Duration (ms)",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            }
          ]
        }

  # =========================================================================
  # CloudWatch Alarms
  # =========================================================================

  ProcessDocumentErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-ProcessDocument-Errors'
      AlarmDescription: Alert when ProcessDocument Lambda has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessDocumentFunction
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  DLQMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-DLQ-Messages'
      AlarmDescription: Alert when messages appear in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt ProcessingDLQ.QueueName
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  StepFunctionsFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-StepFunctions-Failures'
      AlarmDescription: Alert when Step Functions executions fail
      MetricName: ExecutionsFailed
      Namespace: AWS/States
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref ProcessingStateMachine
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  ProcessDocumentThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-ProcessDocument-Throttles'
      AlarmDescription: Alert when ProcessDocument Lambda is throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessDocumentFunction
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  # =========================================================================
  # Cost Management - Monthly Budget
  # =========================================================================

  MonthlyBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub '${ProjectName}-Monthly-Budget'
        BudgetLimit:
          Amount: 100
          Unit: USD
        TimeUnit: MONTHLY
        BudgetType: COST
        CostFilters:
          TagKeyValue:
            - !Sub 'user:Project$${ProjectName}'
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 80
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref AdminEmail
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 100
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref AdminEmail

  # =========================================================================
  # Amplify Deployment via CodeBuild
  # =========================================================================

  AmplifyDeployCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub 'codebuild.${AWS::URLSuffix}'
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/CloudWatchLogsFullAccess'
      Policies:
        - PolicyName: AmplifyDeployPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # CloudFormation - for CDK stack deployment
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource: '*'

              # AppSync - for GraphQL API
              - Effect: Allow
                Action:
                  - appsync:*
                Resource: '*'

              # Lambda - for AppSync resolvers
              - Effect: Allow
                Action:
                  - lambda:CreateFunction
                  - lambda:DeleteFunction
                  - lambda:UpdateFunctionCode
                  - lambda:UpdateFunctionConfiguration
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                  - lambda:TagResource
                  - lambda:UntagResource
                  - lambda:ListTags
                  - lambda:PublishVersion
                  - lambda:CreateAlias
                  - lambda:DeleteAlias
                  - lambda:UpdateAlias
                  - lambda:AddPermission
                  - lambda:RemovePermission
                Resource: '*'

              # IAM - for Lambda execution roles created by CDK
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:GetRole
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:GetRolePolicy
                  - iam:TagRole
                  - iam:UntagRole
                Resource: '*'

              # IAM PassRole - scoped to Amplify and Lambda roles only
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/amplify-*'
                  - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/*LambdaExecutionRole*'
                Condition:
                  StringEquals:
                    iam:PassedToService:
                      - lambda.amazonaws.com
                      - appsync.amazonaws.com

              # S3 - for CDK assets and web component storage
              - Effect: Allow
                Action:
                  - s3:CreateBucket
                  - s3:DeleteBucket
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:PutBucketPolicy
                  - s3:DeleteBucketPolicy
                  - s3:GetBucketPolicy
                  - s3:PutBucketTagging
                  - s3:PutBucketVersioning
                  - s3:PutBucketPublicAccessBlock
                  - s3:PutEncryptionConfiguration
                Resource: '*'

              # CloudFront - for web component CDN
              - Effect: Allow
                Action:
                  - cloudfront:CreateDistribution
                  - cloudfront:UpdateDistribution
                  - cloudfront:GetDistribution
                  - cloudfront:DeleteDistribution
                  - cloudfront:TagResource
                  - cloudfront:CreateOriginAccessControl
                  - cloudfront:DeleteOriginAccessControl
                  - cloudfront:CreateCloudFrontOriginAccessIdentity
                  - cloudfront:DeleteCloudFrontOriginAccessIdentity
                  - cloudfront:GetCloudFrontOriginAccessIdentity
                  - cloudfront:UpdateCloudFrontOriginAccessIdentity
                Resource: '*'

              # CodeBuild - for nested web component build project
              - Effect: Allow
                Action:
                  - codebuild:CreateProject
                  - codebuild:UpdateProject
                  - codebuild:DeleteProject
                  - codebuild:BatchGetProjects
                Resource: '*'

              # Cognito - read-only to verify User Pool
              - Effect: Allow
                Action:
                  - cognito-idp:DescribeUserPool
                  - cognito-idp:DescribeUserPoolClient
                Resource:
                  - !GetAtt UserPool.Arn

              # STS - for CDK context and bootstrap role assumption
              - Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: '*'
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource:
                  - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/cdk-*'

              # SSM - for CDK bootstrap
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource:
                  - !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/cdk-bootstrap/*'

  # Custom resource to update CDK assets bucket policy to allow CodeBuild role
  UpdateCDKBucketPolicyFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-update-cdk-bucket-policy-${DeploymentSuffix}'
      Runtime: python3.13
      Handler: index.handler
      Role: !GetAtt UpdateCDKBucketPolicyRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse

          s3 = boto3.client('s3')

          def handler(event, context):
              try:
                  print(f"Event: {json.dumps(event)}")

                  request_type = event['RequestType']
                  bucket_name = event['ResourceProperties']['BucketName']
                  codebuild_role_arn = event['ResourceProperties']['CodeBuildRoleArn']

                  if request_type in ['Create', 'Update']:
                      # Get existing bucket policy
                      try:
                          response = s3.get_bucket_policy(Bucket=bucket_name)
                          policy = json.loads(response['Policy'])
                      except s3.exceptions.from_code('NoSuchBucketPolicy'):
                          # No existing policy, create new one
                          policy = {
                              'Version': '2012-10-17',
                              'Statement': []
                          }

                      # Add statement to allow CodeBuild role
                      new_statement = {
                          'Sid': 'AllowCodeBuildAccess',
                          'Effect': 'Allow',
                          'Principal': {
                              'AWS': codebuild_role_arn
                          },
                          'Action': [
                              's3:GetObject',
                              's3:PutObject',
                              's3:ListBucket'
                          ],
                          'Resource': [
                              f'arn:aws:s3:::{bucket_name}/*',
                              f'arn:aws:s3:::{bucket_name}'
                          ]
                      }

                      # Remove any existing statement with same Sid
                      policy['Statement'] = [s for s in policy['Statement'] if s.get('Sid') != 'AllowCodeBuildAccess']
                      policy['Statement'].append(new_statement)

                      # Update bucket policy
                      s3.put_bucket_policy(
                          Bucket=bucket_name,
                          Policy=json.dumps(policy)
                      )

                      print(f"Updated bucket policy for {bucket_name}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

                  elif request_type == 'Delete':
                      # On delete, try to remove our statement (best effort)
                      try:
                          response = s3.get_bucket_policy(Bucket=bucket_name)
                          policy = json.loads(response['Policy'])
                          policy['Statement'] = [s for s in policy['Statement'] if s.get('Sid') != 'AllowCodeBuildAccess']

                          if policy['Statement']:
                              s3.put_bucket_policy(Bucket=bucket_name, Policy=json.dumps(policy))
                          else:
                              s3.delete_bucket_policy(Bucket=bucket_name)
                      except Exception as e:
                          print(f"Could not clean up bucket policy: {e}")

                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  UpdateCDKBucketPolicyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: S3BucketPolicyUpdate
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetBucketPolicy
                  - s3:PutBucketPolicy
                  - s3:DeleteBucketPolicy
                Resource: !Sub 'arn:${AWS::Partition}:s3:::cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}'

  UpdateCDKBucketPolicy:
    Type: Custom::UpdateCDKBucketPolicy
    Properties:
      ServiceToken: !GetAtt UpdateCDKBucketPolicyFunction.Arn
      BucketName: !Sub 'cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}'
      CodeBuildRoleArn: !GetAtt AmplifyDeployCodeBuildRole.Arn

  # Custom resource to grant CDK deploy role permission to pass our CodeBuild role
  UpdateCDKDeployRoleFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-update-cdk-deploy-role-${DeploymentSuffix}'
      Runtime: python3.13
      Handler: index.handler
      Role: !GetAtt UpdateCDKDeployRoleRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse

          iam = boto3.client('iam')

          def handler(event, context):
              try:
                  print(f"Event: {json.dumps(event)}")

                  request_type = event['RequestType']
                  deploy_role_name = event['ResourceProperties']['DeployRoleName']
                  codebuild_role_arn = event['ResourceProperties']['CodeBuildRoleArn']

                  policy_name = 'AllowPassCodeBuildRole'

                  if request_type in ['Create', 'Update']:
                      # Create or update inline policy on CDK deploy role
                      policy_document = {
                          'Version': '2012-10-17',
                          'Statement': [
                              {
                                  'Effect': 'Allow',
                                  'Action': 'iam:PassRole',
                                  'Resource': codebuild_role_arn
                              }
                          ]
                      }

                      iam.put_role_policy(
                          RoleName=deploy_role_name,
                          PolicyName=policy_name,
                          PolicyDocument=json.dumps(policy_document)
                      )

                      print(f"Updated {deploy_role_name} with iam:PassRole for {codebuild_role_arn}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

                  elif request_type == 'Delete':
                      # On delete, try to remove our inline policy (best effort)
                      try:
                          iam.delete_role_policy(
                              RoleName=deploy_role_name,
                              PolicyName=policy_name
                          )
                          print(f"Removed policy {policy_name} from {deploy_role_name}")
                      except iam.exceptions.NoSuchEntityException:
                          print(f"Policy {policy_name} not found on {deploy_role_name}")
                      except Exception as e:
                          print(f"Could not remove policy: {e}")

                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  UpdateCDKDeployRoleRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: UpdateIAMRole
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:GetRolePolicy
                Resource: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/cdk-hnb659fds-deploy-role-${AWS::AccountId}-${AWS::Region}'

  UpdateCDKDeployRole:
    Type: Custom::UpdateCDKDeployRole
    Properties:
      ServiceToken: !GetAtt UpdateCDKDeployRoleFunction.Arn
      DeployRoleName: !Sub 'cdk-hnb659fds-deploy-role-${AWS::AccountId}-${AWS::Region}'
      CodeBuildRoleArn: !GetAtt AmplifyDeployCodeBuildRole.Arn

  # Custom resource to create Amplify placeholder in S3
  CreateAmplifyPlaceholderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-create-amplify-placeholder-${DeploymentSuffix}'
      Runtime: python3.13
      Handler: index.handler
      Role: !GetAtt CreateAmplifyPlaceholderRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse
          import zipfile
          import io

          s3 = boto3.client('s3')

          def handler(event, context):
              try:
                  print(f"Event: {json.dumps(event)}")

                  request_type = event['RequestType']
                  bucket_name = event['ResourceProperties']['BucketName']
                  key = event['ResourceProperties']['Key']

                  if request_type in ['Create', 'Update']:
                      # Create minimal valid zip file
                      zip_buffer = io.BytesIO()
                      with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
                          # Add a minimal placeholder file
                          zip_file.writestr('placeholder.txt',
                              'This is a placeholder. Actual source will be provided at build time via sourceLocationOverride.')

                      # Upload to S3
                      s3.put_object(
                          Bucket=bucket_name,
                          Key=key,
                          Body=zip_buffer.getvalue(),
                          ContentType='application/zip'
                      )

                      print(f"Created placeholder at s3://{bucket_name}/{key}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

                  elif request_type == 'Delete':
                      # Clean up on delete (best effort)
                      try:
                          s3.delete_object(Bucket=bucket_name, Key=key)
                          print(f"Deleted placeholder from s3://{bucket_name}/{key}")
                      except Exception as e:
                          print(f"Could not delete placeholder: {e}")

                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  CreateAmplifyPlaceholderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: S3PlaceholderAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}/*'

  CreateAmplifyPlaceholder:
    Type: Custom::CreateAmplifyPlaceholder
    Properties:
      ServiceToken: !GetAtt CreateAmplifyPlaceholderFunction.Arn
      BucketName: !Ref UISourceBucket
      Key: 'amplify-placeholder.zip'

  AmplifyDeployProject:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - UpdateCDKBucketPolicy
      - UpdateCDKDeployRole
      - CreateAmplifyPlaceholder
    Properties:
      Name: !Sub '${ProjectName}-amplify-deploy-${DeploymentSuffix}'
      Description: Deploy Amplify Gen 2 backend via CDK
      ServiceRole: !GetAtt AmplifyDeployCodeBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        EnvironmentVariables:
          - Name: PROJECT_NAME
            Value: !Ref ProjectName
          - Name: AWS_REGION
            Value: !Ref AWS::Region
          - Name: USERPOOLID
            Value: !Ref UserPool
          - Name: USERPOOLCLIENTID
            Value: !Ref UserPoolClient
          - Name: DEPLOYMENT_SUFFIX
            Value: !Ref DeploymentSuffix
          - Name: ARTIFACT_BUCKET
            Value: !Ref UISourceBucket
      Source:
        Type: S3
        Location: !Sub '${UISourceBucket}/amplify-placeholder.zip'
        BuildSpec: |
          # BuildSpec updated: 2025-11-07 - Added --ignore-scripts flags
          version: 0.2
          phases:
            install:
              runtime-versions:
                nodejs: 24
              commands:
                - echo "Installing system dependencies..."
                - yum install -y git
                - echo "Installing dependencies..."
                - npm ci --prefix amplify --ignore-scripts
                - echo "Installing esbuild to root for CDK bundling..."
                - npm install esbuild@0.25.12 --ignore-scripts
            pre_build:
              commands:
                - echo "Environment check..."
                - echo "PROJECT_NAME=$PROJECT_NAME"
                - echo "AWS_REGION=$AWS_REGION"
                - echo "USERPOOLID=$USERPOOLID"
                - echo "USERPOOLCLIENTID=$USERPOOLCLIENTID"
                - node --version
                - npm --version
                - echo "Checking for lock file..."
                - ls -la amplify/package-lock.json || echo "Lock file not found in amplify/"
                - ls -la package-lock.json || echo "Lock file not found in root"
                - echo "Ensuring lock file is accessible..."
                - test -f amplify/package-lock.json && cp amplify/package-lock.json . || echo "No lock file to copy"
            build:
              commands:
                - echo "Cleaning up cached CDK/Amplify state..."
                - rm -rf .amplify/ amplify/.amplify/ amplify/cdk.out/
                - echo "Deploying Amplify backend via CDK..."
                - |
                  # Export environment variables needed by CDK stack
                  export KNOWLEDGE_BASE_ID=${KNOWLEDGE_BASE_ID}
                  export CONFIGURATION_TABLE_NAME=${CONFIGURATION_TABLE_NAME}

                  # Deploy CDK stack
                  cd amplify

                  echo "Running: npx cdk deploy --all --require-approval never --outputs-file ./cdk-outputs.json"

                  if ! npx cdk deploy --all --require-approval never --outputs-file ./cdk-outputs.json; then
                    echo "âŒ CDK deployment failed!"
                    echo "Checking for common issues..."

                    # Check if CDK is bootstrapped
                    echo "Checking CDK bootstrap status..."
                    aws cloudformation describe-stacks --stack-name CDKToolkit --region ${AWS_REGION} 2>&1 || echo "âš ï¸ CDK not bootstrapped"

                    # Show any CloudFormation stacks in failed state
                    echo "Checking for failed stacks..."
                    aws cloudformation list-stacks --stack-status-filter CREATE_FAILED UPDATE_FAILED ROLLBACK_COMPLETE --query "StackSummaries[?contains(StackName, 'amplify')].{Name:StackName,Status:StackStatus}" --output table

                    exit 1
                  fi

                  cd ..
                  echo "âœ“ CDK deployment complete"
                - echo "Generating amplify_outputs.json from CDK outputs..."
                - |
                  # Convert CDK outputs to Amplify Gen 2 format
                  STACK_NAME="amplify-${PROJECT_NAME}-backend"

                  # Verify stack exists
                  if ! aws cloudformation describe-stacks --stack-name "$STACK_NAME" &>/dev/null; then
                    echo "âŒ Error: CDK stack $STACK_NAME does not exist!"
                    echo "CDK deployment must have failed silently."
                    exit 1
                  fi

                  # Get stack outputs
                  API_ENDPOINT=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='GraphQLApiEndpoint'].OutputValue" --output text)
                  API_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='GraphQLApiId'].OutputValue" --output text)
                  REGION=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='Region'].OutputValue" --output text)

                  # Validate outputs are not empty
                  if [ -z "$API_ENDPOINT" ] || [ "$API_ENDPOINT" = "None" ] || [ -z "$API_ID" ] || [ "$API_ID" = "None" ]; then
                    echo "âŒ Error: CDK stack exists but has no API outputs!"
                    echo "API_ENDPOINT: $API_ENDPOINT"
                    echo "API_ID: $API_ID"
                    echo "Stack outputs:"
                    aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs" --output table
                    exit 1
                  fi

                  echo "âœ“ Retrieved CDK outputs:"
                  echo "  API Endpoint: $API_ENDPOINT"
                  echo "  API ID: $API_ID"
                  echo "  Region: $REGION"

                  # Create amplify_outputs.json in Amplify Gen 2 format
                  cat > amplify_outputs.json <<EOF
                  {
                    "version": "1.4",
                    "auth": {
                      "aws_region": "$REGION",
                      "user_pool_id": "$USERPOOLID",
                      "user_pool_client_id": "$USERPOOLCLIENTID",
                      "identity_pool_id": "",
                      "password_policy": {
                        "min_length": 8,
                        "require_numbers": true,
                        "require_lowercase": true,
                        "require_uppercase": true,
                        "require_symbols": true
                      },
                      "oauth": {},
                      "username_attributes": ["email"],
                      "user_verification_types": ["email"],
                      "mfa_methods": [],
                      "mfa_configuration": "OPTIONAL"
                    },
                    "data": {
                      "aws_region": "$REGION",
                      "url": "$API_ENDPOINT",
                      "api_id": "$API_ID",
                      "default_authorization_type": "AMAZON_COGNITO_USER_POOLS",
                      "authorization_types": ["AWS_LAMBDA"]
                    }
                  }
                  EOF

                  echo "âœ“ amplify_outputs.json generated successfully"
                  cat amplify_outputs.json
            post_build:
              commands:
                - echo "Amplify backend deployment complete"
                - echo "Uploading amplify_outputs.json to S3 for web component build..."
                - |
                  # Find amplify_outputs.json
                  OUTPUT_FILE=""
                  if [ -f "amplify_outputs.json" ]; then
                    OUTPUT_FILE="amplify_outputs.json"
                  elif [ -f "amplify/amplify_outputs.json" ]; then
                    OUTPUT_FILE="amplify/amplify_outputs.json"
                  else
                    echo "âŒ Error: amplify_outputs.json not found in expected locations"
                    echo "Searched: ./amplify_outputs.json and ./amplify/amplify_outputs.json"
                    ls -la amplify/ || true
                    exit 1
                  fi

                  # Validate file is not empty and contains required fields
                  echo "Validating amplify_outputs.json..."
                  cat "$OUTPUT_FILE"
                  if ! grep -q "auth" "$OUTPUT_FILE" && ! grep -q "data" "$OUTPUT_FILE"; then
                    echo "âš ï¸  Warning: amplify_outputs.json appears to be empty or malformed"
                    echo "File contents:"
                    cat "$OUTPUT_FILE"
                  fi

                  # Upload to S3
                  aws s3 cp "$OUTPUT_FILE" s3://${ARTIFACT_BUCKET}/amplify_outputs.json
                  echo "âœ“ amplify_outputs.json uploaded successfully from $OUTPUT_FILE"
                - echo "Listing Amplify CloudFormation stacks created by sandbox..."
                - aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query 'StackSummaries[?contains(StackName, `amplify-`)].{Name:StackName, Status:StackStatus}' --output table || true
                - echo "Note - Web component CDN is managed by SAM stack (not Amplify)"
      TimeoutInMinutes: 30
      Cache:
        Type: LOCAL
        Modes:
          - LOCAL_SOURCE_CACHE
          - LOCAL_CUSTOM_CACHE

Outputs:
  # S3 Buckets
  InputBucketName:
    Description: S3 bucket for document uploads
    Value: !Ref InputBucket
    Export:
      Name: !Sub '${AWS::StackName}-InputBucket'

  OutputBucketName:
    Description: S3 bucket for processed documents
    Value: !Ref OutputBucket
    Export:
      Name: !Sub '${AWS::StackName}-OutputBucket'

  WorkingBucketName:
    Description: S3 bucket for temporary working files
    Value: !Ref WorkingBucket
    Export:
      Name: !Sub '${AWS::StackName}-WorkingBucket'

  VectorBucketName:
    Description: S3 bucket for embeddings and vectors
    Value: !Ref VectorBucket
    Export:
      Name: !Sub '${AWS::StackName}-VectorBucket'

  UIBucketName:
    Description: S3 bucket for WebUI hosting
    Value: !Ref UIBucket
    Export:
      Name: !Sub '${AWS::StackName}-UIBucket'

  ArtifactBucketName:
    Condition: BuildUI
    Description: S3 bucket for deployment artifacts (UI source, web component source)
    Value: !Ref UISourceBucket
    Export:
      Name: !Sub '${AWS::StackName}-ArtifactBucket'

  # DynamoDB Tables
  TrackingTableName:
    Description: DynamoDB table for document tracking
    Value: !Ref TrackingTable
    Export:
      Name: !Sub '${AWS::StackName}-TrackingTable'

  MeteringTableName:
    Description: DynamoDB table for usage metering
    Value: !Ref MeteringTable
    Export:
      Name: !Sub '${AWS::StackName}-MeteringTable'

  ConfigurationTableName:
    Description: Configuration DynamoDB Table Name
    Value: !Ref ConfigurationTable
    Export:
      Name: !Sub '${AWS::StackName}-ConfigurationTable'

  ConfigurationTableArn:
    Description: Configuration DynamoDB Table ARN
    Value: !GetAtt ConfigurationTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ConfigurationTableArn'

  # Lambda Functions
  ProcessDocumentFunctionArn:
    Description: Process document Lambda ARN
    Value: !GetAtt ProcessDocumentFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ProcessDocumentFunction'

  QueryKBFunctionArn:
    Description: Query Knowledge Base Lambda ARN
    Value: !GetAtt QueryKBFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-QueryKBFunction'

  # Step Functions
  StateMachineArn:
    Description: Step Functions state machine ARN
    Value: !GetAtt ProcessingStateMachine.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StateMachine'

  # Knowledge Base
  KnowledgeBaseId:
    Description: Bedrock Knowledge Base ID
    Value: !GetAtt KnowledgeBase.KnowledgeBaseId
    Export:
      Name: !Sub '${AWS::StackName}-KnowledgeBaseId'

  KnowledgeBaseArn:
    Description: Bedrock Knowledge Base ARN
    Value: !GetAtt KnowledgeBase.KnowledgeBaseArn
    Export:
      Name: !Sub '${AWS::StackName}-KnowledgeBaseArn'

  DataSourceId:
    Description: Bedrock Knowledge Base Data Source ID
    Value: !GetAtt KnowledgeBase.DataSourceId
    Export:
      Name: !Sub '${AWS::StackName}-DataSourceId'

  # API & Authentication
  GraphQLApiUrl:
    Description: GraphQL API URL
    Value: !GetAtt GraphQLApi.GraphQLUrl
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLApiUrl'

  GraphQLApiId:
    Description: GraphQL API ID
    Value: !GetAtt GraphQLApi.ApiId
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLApiId'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolId'

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolClientId'

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref IdentityPool
    Export:
      Name: !Sub '${AWS::StackName}-IdentityPoolId'

  # Configuration
  Region:
    Description: AWS Region
    Value: !Ref AWS::Region

  StackName:
    Description: CloudFormation Stack Name
    Value: !Ref AWS::StackName

  # CloudFront
  CloudFrontDomain:
    Description: CloudFront distribution domain
    Value: !GetAtt CloudFrontDistribution.DomainName

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref CloudFrontDistribution

  UIUrl:
    Description: UI URL (HTTPS via CloudFront)
    Value: !Sub 'https://${CloudFrontDistribution.DomainName}'

  # Web Component CDN
  WebComponentCDNUrl:
    Description: CDN URL for embeddable chat web component
    Value: !Sub 'https://${WebComponentDistribution.DomainName}/amplify-chat.js'
    Export:
      Name: !Sub '${AWS::StackName}-WebComponentCDNUrl'

  WebComponentDistributionId:
    Description: CloudFront distribution ID for web component
    Value: !Ref WebComponentDistribution
    Export:
      Name: !Sub '${AWS::StackName}-WebComponentDistributionId'

  WebComponentBuildProjectName:
    Description: CodeBuild project name for web component deployment
    Value: !Ref WebComponentBuildProject
    Export:
      Name: !Sub '${AWS::StackName}-WebComponentBuildProject'

  WebComponentAssetsBucketName:
    Description: S3 bucket for web component assets
    Value: !Ref WebComponentAssetsBucket
    Export:
      Name: !Sub '${AWS::StackName}-WebComponentAssetsBucket'

  # Amplify Deployment
  AmplifyDeployProjectName:
    Description: CodeBuild project name for Amplify deployment
    Value: !Ref AmplifyDeployProject
    Export:
      Name: !Sub '${AWS::StackName}-AmplifyDeployProject'

  AmplifyDeployProjectArn:
    Description: CodeBuild project ARN for Amplify deployment
    Value: !GetAtt AmplifyDeployProject.Arn
