<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full Diagnostic Test</title>
  <style>
    body {
      font-family: monospace;
      margin: 20px;
      background: #f5f5f5;
    }
    .debug {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .warning { color: orange; }
    pre {
      background: #f8f8f8;
      padding: 10px;
      overflow-x: auto;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>Full Diagnostic Test</h1>

  <div class="debug">
    <h2>1. Console Errors</h2>
    <div id="errors">No errors yet...</div>
  </div>

  <div class="debug">
    <h2>2. Script Load Status</h2>
    <div id="script-status">Loading script...</div>
  </div>

  <div class="debug">
    <h2>3. Global Scope Check</h2>
    <div id="globals">Checking after script loads...</div>
  </div>

  <div class="debug">
    <h2>4. Custom Element Status</h2>
    <div id="element-status">Checking after script loads...</div>
  </div>

  <div class="debug">
    <h2>5. Network Request</h2>
    <div id="network">Checking...</div>
  </div>

  <div class="debug">
    <h2>6. Chat Component (will appear if registered)</h2>
    <amplify-chat conversation-id="diagnostic-test"></amplify-chat>
  </div>

  <script>
    const errors = [];
    const logs = [];

    // Intercept ALL errors
    window.addEventListener('error', (e) => {
      const errorMsg = `${e.message}\n  at ${e.filename}:${e.lineno}:${e.colno}`;
      errors.push(errorMsg);
      updateErrors();
      e.preventDefault(); // Don't let errors stop execution
    });

    // Intercept unhandled promise rejections
    window.addEventListener('unhandledrejection', (e) => {
      errors.push(`Unhandled Promise Rejection: ${e.reason}`);
      updateErrors();
    });

    // Intercept console.error
    const originalError = console.error;
    console.error = function(...args) {
      errors.push('Console Error: ' + args.join(' '));
      updateErrors();
      originalError.apply(console, args);
    };

    // Intercept console.warn
    const originalWarn = console.warn;
    console.warn = function(...args) {
      logs.push('⚠️ ' + args.join(' '));
      originalWarn.apply(console, args);
    };

    function updateErrors() {
      const errorsEl = document.getElementById('errors');
      if (errors.length === 0) {
        errorsEl.innerHTML = '<div class="success">✓ No errors detected</div>';
      } else {
        errorsEl.innerHTML = errors.map(err =>
          `<div class="error">❌ ${err}</div>`
        ).join('');
      }
    }

    // Load script with cache-bust
    const timestamp = new Date().getTime();
    const scriptUrl = `https://d2m6vpu87luaxh.cloudfront.net/amplify-chat.js?v=${timestamp}`;

    console.log('Loading script from:', scriptUrl);

    const script = document.createElement('script');
    script.src = scriptUrl;

    script.onload = () => {
      document.getElementById('script-status').innerHTML =
        '<div class="success">✓ Script loaded successfully (no network error)</div>' +
        `<div>URL: ${scriptUrl}</div>`;

      // Check network request details
      checkNetwork();

      // Wait a moment for script to execute
      setTimeout(() => {
        checkGlobals();
        checkCustomElement();
        updateErrors();
      }, 1000);
    };

    script.onerror = () => {
      document.getElementById('script-status').innerHTML =
        '<div class="error">❌ Script failed to load (network error)</div>' +
        `<div>URL: ${scriptUrl}</div>`;
    };

    document.head.appendChild(script);

    function checkNetwork() {
      // Try to fetch headers
      fetch(scriptUrl, { method: 'HEAD' })
        .then(response => {
          document.getElementById('network').innerHTML = `
            <div class="success">✓ Fetch successful</div>
            <div>Status: ${response.status}</div>
            <div>Content-Type: ${response.headers.get('content-type')}</div>
            <div>Content-Length: ${response.headers.get('content-length')} bytes</div>
            <div>Cache-Control: ${response.headers.get('cache-control')}</div>
            <div>X-Cache: ${response.headers.get('x-cache')}</div>
          `;
        })
        .catch(err => {
          document.getElementById('network').innerHTML =
            `<div class="error">❌ Fetch failed: ${err.message}</div>`;
        });
    }

    function checkGlobals() {
      const globalsEl = document.getElementById('globals');
      const found = [];

      // Check for various possible globals
      if (window.AmplifyChat) found.push('window.AmplifyChat');
      if (window.Amplify) found.push('window.Amplify');

      // Check for UMD module export
      const allGlobals = Object.keys(window).filter(key =>
        key.includes('Amplify') || key.includes('amplify') || key.includes('Chat')
      );

      if (found.length > 0 || allGlobals.length > 0) {
        globalsEl.innerHTML = `
          <div class="success">Found globals: ${found.join(', ')}</div>
          <div>All Amplify-related: ${allGlobals.join(', ')}</div>
        `;

        // Show structure of window.AmplifyChat
        if (window.AmplifyChat) {
          const type = typeof window.AmplifyChat;
          const keys = Object.keys(window.AmplifyChat);
          globalsEl.innerHTML += `
            <div>Type: ${type}</div>
            <div>Properties: ${keys.join(', ')}</div>
          `;
        }
      } else {
        globalsEl.innerHTML = `
          <div class="warning">⚠️ No Amplify-related globals found</div>
          <div>This suggests IIFE format OR script crashed during execution</div>
          <div>Check Console Errors section above for details</div>
        `;
      }
    }

    function checkCustomElement() {
      const statusEl = document.getElementById('element-status');
      const isDefined = customElements.get('amplify-chat');

      if (isDefined) {
        statusEl.innerHTML = '<div class="success">✅ Custom element IS registered!</div>';
      } else {
        statusEl.innerHTML = '<div class="error">❌ Custom element NOT registered</div>';

        // Try manual registration if we have the class
        if (window.AmplifyChat) {
          tryManualRegistration(statusEl);
        }
      }

      // Show details about what's in window.AmplifyChat
      if (window.AmplifyChat) {
        const type = typeof window.AmplifyChat;
        const isFunc = typeof window.AmplifyChat === 'function';
        const keys = Object.keys(window.AmplifyChat);

        statusEl.innerHTML += `
          <div style="margin-top: 10px; padding: 10px; background: #f8f8f8; border: 1px solid #ddd;">
            <strong>window.AmplifyChat structure:</strong><br>
            Type: ${type}<br>
            Is Function: ${isFunc}<br>
            Properties: ${keys.join(', ') || '(none)'}<br>
            Has .AmplifyChat: ${!!window.AmplifyChat.AmplifyChat}<br>
            Has .default: ${!!window.AmplifyChat.default}
          </div>
        `;
      }
    }

    function tryManualRegistration(statusEl) {
      let registered = false;

      // Try different paths to the class
      const attempts = [
        { path: 'window.AmplifyChat.AmplifyChat', value: window.AmplifyChat?.AmplifyChat },
        { path: 'window.AmplifyChat', value: window.AmplifyChat },
        { path: 'window.AmplifyChat.default', value: window.AmplifyChat?.default },
      ];

      for (const attempt of attempts) {
        if (typeof attempt.value === 'function') {
          try {
            customElements.define('amplify-chat', attempt.value);
            statusEl.innerHTML += `<div class="success">✅ Manually registered from ${attempt.path}!</div>`;
            registered = true;
            break;
          } catch (e) {
            statusEl.innerHTML += `<div class="error">Failed to register from ${attempt.path}: ${e.message}</div>`;
          }
        }
      }

      if (!registered) {
        statusEl.innerHTML += '<div class="error">Could not find valid class to register</div>';
      }
    }
  </script>
</body>
</html>
