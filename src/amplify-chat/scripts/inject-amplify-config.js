#!/usr/bin/env node

/**
 * Inject Amplify Configuration into Web Component Build
 *
 * This script runs before the Vite build to embed amplify_outputs.json
 * into the web component bundle. This allows zero-config embedding.
 *
 * Usage: node scripts/inject-amplify-config.js
 *
 * Reads: ../../../amplify_outputs.json (from repo root)
 * Writes: src/amplify-config.generated.ts (imported by src/wc.ts)
 */

const fs = require('fs');
const path = require('path');

// Paths relative to src/amplify-chat/scripts/
// Try local directory first (for CodeBuild), then repo root (for local dev)
const LOCAL_OUTPUTS_PATH = path.join(__dirname, '../amplify_outputs.json');
const REPO_ROOT_OUTPUTS_PATH = path.join(__dirname, '../../../amplify_outputs.json');
const GENERATED_CONFIG_PATH = path.join(__dirname, '../src/amplify-config.generated.ts');

function main() {
  console.log('üîß Injecting Amplify configuration into web component...');

  // Check if amplify_outputs.json exists (try local first, then repo root)
  let AMPLIFY_OUTPUTS_PATH;
  if (fs.existsSync(LOCAL_OUTPUTS_PATH)) {
    AMPLIFY_OUTPUTS_PATH = LOCAL_OUTPUTS_PATH;
    console.log('‚úì Found amplify_outputs.json at local path:', LOCAL_OUTPUTS_PATH);
  } else if (fs.existsSync(REPO_ROOT_OUTPUTS_PATH)) {
    AMPLIFY_OUTPUTS_PATH = REPO_ROOT_OUTPUTS_PATH;
    console.log('‚úì Found amplify_outputs.json at repo root:', REPO_ROOT_OUTPUTS_PATH);
  } else {
    console.error('‚ùå Error: amplify_outputs.json not found at either:');
    console.error('   Local:', LOCAL_OUTPUTS_PATH);
    console.error('   Repo root:', REPO_ROOT_OUTPUTS_PATH);
    console.error('   Run `npx ampx deploy` first to generate Amplify configuration.');
    process.exit(1);
  }

  try {
    // Read and parse amplify_outputs.json
    const amplifyOutputsRaw = fs.readFileSync(AMPLIFY_OUTPUTS_PATH, 'utf-8');
    const amplifyOutputs = JSON.parse(amplifyOutputsRaw);

    // Generate TypeScript config file
    const configContent = `/**
 * Auto-generated Amplify Configuration
 *
 * This file is generated by scripts/inject-amplify-config.js during build.
 * DO NOT EDIT MANUALLY - changes will be overwritten.
 *
 * Generated: ${new Date().toISOString()}
 */

export const AMPLIFY_OUTPUTS = ${JSON.stringify(amplifyOutputs, null, 2)} as const;
`;

    // Write config file
    fs.writeFileSync(GENERATED_CONFIG_PATH, configContent, 'utf-8');

    console.log('‚úÖ Amplify configuration injected successfully');
    console.log(`   API Endpoint: ${amplifyOutputs.data?.url || 'N/A'}`);
    console.log(`   Region: ${amplifyOutputs.auth?.aws_region || 'N/A'}`);

  } catch (error) {
    console.error('‚ùå Error injecting configuration:', error.message);
    process.exit(1);
  }
}

main();
