<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cache-Busted Test</title>
  <style>
    body {
      font-family: monospace;
      margin: 20px;
      background: #f5f5f5;
    }
    .debug {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Cache-Busted Web Component Test</h1>

  <div class="debug">
    <h2>Status</h2>
    <div id="status">Loading...</div>
  </div>

  <div class="debug">
    <h2>Chat Component</h2>
    <amplify-chat conversation-id="test"></amplify-chat>
  </div>

  <script>
    // Add timestamp to force cache bust
    const timestamp = new Date().getTime();
    const script = document.createElement('script');
    script.src = `https://d3w5cdfl4m6ati.cloudfront.net/amplify-chat.js?v=${timestamp}`;

    script.onload = () => {
      console.log('✓ Script loaded with cache-bust');

      setTimeout(() => {
        const isDefined = customElements.get('amplify-chat');
        const statusEl = document.getElementById('status');

        if (isDefined) {
          statusEl.innerHTML = '<div class="success">✅ SUCCESS! Custom element registered!</div>';
        } else {
          // Check what we got
          const hasAmplifyChat = window.AmplifyChat;
          const hasWindow = window.Amplify;

          let details = '';
          if (hasAmplifyChat) {
            details += '<div>Found window.AmplifyChat (UMD format detected!)</div>';
            details += '<div>Type: ' + typeof hasAmplifyChat + '</div>';

            // Try multiple ways to extract the class from UMD
            let classFound = false;

            // Try 1: UMD exports as object with AmplifyChat property
            if (hasAmplifyChat.AmplifyChat && typeof hasAmplifyChat.AmplifyChat === 'function') {
              try {
                customElements.define('amplify-chat', hasAmplifyChat.AmplifyChat);
                details += '<div class="success">✅ Manually registered from window.AmplifyChat.AmplifyChat!</div>';
                classFound = true;
              } catch (e) {
                details += '<div class="error">Method 1 failed: ' + e.message + '</div>';
              }
            }

            // Try 2: UMD exports directly
            if (!classFound && typeof hasAmplifyChat === 'function') {
              try {
                customElements.define('amplify-chat', hasAmplifyChat);
                details += '<div class="success">✅ Manually registered from window.AmplifyChat!</div>';
                classFound = true;
              } catch (e) {
                details += '<div class="error">Method 2 failed: ' + e.message + '</div>';
              }
            }

            // Try 3: Check for default export
            if (!classFound && hasAmplifyChat.default && typeof hasAmplifyChat.default === 'function') {
              try {
                customElements.define('amplify-chat', hasAmplifyChat.default);
                details += '<div class="success">✅ Manually registered from window.AmplifyChat.default!</div>';
                classFound = true;
              } catch (e) {
                details += '<div class="error">Method 3 failed: ' + e.message + '</div>';
              }
            }

            if (!classFound) {
              details += '<div class="error">Could not find AmplifyChat class in any expected location</div>';
              details += '<div>Available properties: ' + Object.keys(hasAmplifyChat).join(', ') + '</div>';
            }
          }

          statusEl.innerHTML = `
            <div class="error">❌ Custom element NOT registered</div>
            ${details}
            <div style="margin-top: 10px">
              <strong>Debug:</strong><br>
              Cache-bust timestamp: ${timestamp}<br>
              Loaded from: ${script.src}
            </div>
          `;
        }
      }, 500);
    };

    script.onerror = () => {
      document.getElementById('status').innerHTML =
        '<div class="error">❌ Script failed to load</div>';
    };

    document.head.appendChild(script);
  </script>
</body>
</html>
