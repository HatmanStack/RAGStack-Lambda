# Architecture: Optional Amplify Chat Stack

This document explains the architecture for RAGStack-Lambda with optional Amplify chat deployed as a separate stack.

## High-Level Architecture

```
                        Bedrock Knowledge Base
                    (Vectors from all documents)
                               ↑
                    ┌──────────┴──────────┐
                    │                     │
              ┌─────▼──────┐        ┌────▼──────┐
              │ SAM Stack  │        │ Amplify   │
              │ (Required) │        │ Stack     │
              │            │        │ (Optional)│
              └─────▲──────┘        └────▲──────┘
                    │                    │
         ┌──────────┼────────────────────┼──────────┐
         │          │                    │          │
    ┌────▼──┐  ┌───▼────┐         ┌────▼──┐  ┌───▼────┐
    │Process│  │Generate │         │ Chat  │  │ Source │
    │Document│  │Embeddings│       │Lambda │  │Extraction
    └────────┘  └────────┘         └───────┘  └────────┘
         │          │                    │          │
         └──────────┼────────────────────┼──────────┘
                    │                    │
            ┌───────▼────────┐   ┌──────▼───────┐
            │ DocumentTable  │   │Conversation  │
            │ (DynamoDB)     │   │Table (DynamoDB)
            └────────────────┘   └──────────────┘

    Search Feature (always)         Chat Feature (optional)
```

## Stack 1: Core System (SAM - Always Deployed)

**CloudFormation Stack Name**: `RAGStack-<project-name>`

### Resources
```
template.yaml (existing)
├── ProcessDocument Function (Lambda)
├── GenerateEmbeddings Function (Lambda)
├── QueryKB Function (Lambda) ◄── Chat uses this
├── DocumentTable (DynamoDB)
├── EventBridge Rule (triggers ProcessDocument)
├── Step Functions StateMachine
├── S3 Buckets (input, extracted, vectors)
├── Cognito UserPool
├── AppSync API (for search UI)
└── React UI (CloudFront + S3)
```

### Outputs
```yaml
QueryKbLambdaArn: arn:aws:lambda:...   # Chat stack needs this
BedrockKbId: "XXXXXXXX"                # Chat stack needs this
DocumentTableName: "DocumentTable-..."  # Chat can reference
CognitoUserPoolId: "us-east-1_..."      # Chat can reference
```

### Deployment
```bash
python publish.py \
  --project-name my-app \
  --admin-email user@example.com \
  --region us-east-1
```

## Stack 2: Chat Feature (Amplify - Optional)

**CloudFormation Stack Name**: `amplify-chat-<app-id>`

### Resources (Auto-Generated by Amplify)
```
amplify/data/resource.ts (defines schema)
├── ConversationRoute (GraphQL mutation)
├── Chat Handler Lambda (auto-generated)
├── ConversationTable (DynamoDB, auto-generated)
├── AppSync API (auto-generated)
├── IAM Roles (auto-generated)
├── Bedrock Permissions (auto-generated)
└── Custom Resolvers (extractSources.ts)
```

### Custom Code (TypeScript)
```typescript
amplify/data/
├── resource.ts                          # Defines conversation route
└── functions/
    └── extractSources.ts                # Extracts sources from KB citations
```

### Deployment
```bash
cd amplify/
export BEDROCK_KB_ID="<from-SAM-outputs>"
export QUERY_KB_LAMBDA_ARN="<from-SAM-outputs>"
npx amplify publish
```

## Shared Resources

| Resource | Owner | Used By |
|----------|-------|---------|
| **Bedrock Knowledge Base** | SAM (created manually) | Both search + chat |
| **Bedrock models** | AWS | ProcessDoc, GenerateEmbed, Chat |
| **Cognito User Pool** | SAM (optional) | React UI, Chat (same pool) |

## Data Flow Diagram

### Document Processing Pipeline (Core)
```
User Upload
    ↓
S3 Input Bucket
    ↓
EventBridge Rule
    ↓
ProcessDocument Lambda
    ├─→ OCR (Textract or Bedrock)
    ├─→ Text extraction
    └─→ S3 Extracted Bucket
        ↓
    GenerateEmbeddings Lambda
    ├─→ Titan Embeddings
    ├─→ S3 Vector Bucket
    └─→ Bedrock Knowledge Base (indexed)
        ↓
    DocumentTable (success/failure tracking)
```

### Search Feature (SAM)
```
User Query (Search UI)
    ↓
AppSync API (SAM-managed)
    ↓
QueryKB Lambda
    ├─→ Bedrock KB RetrieveAndGenerate
    ├─→ Extract sources from citations
    └─→ Return (answer + sources)
        ↓
    Search UI displays results
```

### Chat Feature (Amplify - Optional)
```
User Message (Chat UI)
    ↓
AppSync API (Amplify-managed)
    ↓
Chat Lambda (Amplify auto-generated)
    ├─→ Bedrock RetrieveAndGenerate
    │   (same KB as search)
    ├─→ extractSources.ts (custom)
    │   (extracts & formats citations)
    └─→ ConversationTable writes message
        ↓
    Chat UI streams response + sources
        ↓
    Later: ConversationTable reads history
```

## Deployment Sequence

### First Time: Deploy Both Stacks

```
Step 1: Deploy SAM Core
┌─────────────────────────────┐
│ python publish.py           │
│  --project-name myapp       │
│  --admin-email user@e.com   │
│  --region us-east-1         │
└──────────────┬──────────────┘
               │
        [Wait for completion]
               │
            Save outputs:
            - QUERY_KB_LAMBDA_ARN
            - BEDROCK_KB_ID
               ↓
Step 2: Deploy Amplify Chat
┌──────────────────────────────┐
│ cd amplify                   │
│ export BEDROCK_KB_ID="..."   │
│ export QUERY_KB_LAMBDA_ARN="│
│ npx amplify publish          │
└──────────────┬───────────────┘
               │
        [Wait for completion]
               ↓
     Chat + Search Live!
```

### Later: Update Only Chat

```
# Update only Amplify stack
cd amplify/
# Edit amplify/data/resource.ts or functions/extractSources.ts
npx amplify publish

# SAM stack unchanged, search continues working
```

### Later: Update Core + Chat Auto-Syncs

```
# Update SAM stack (new documents, new models, etc.)
python publish.py --skip-ui  # Rebuild Lambda packages

# Amplify chat still works:
# - Uses same Bedrock KB (auto-updated)
# - QueryKB Lambda ARN doesn't change (typically)
# - Chat continues without re-deployment
```

## Cross-Stack References

### How Chat Uses Core Resources

**Amplify resource.ts references SAM outputs:**

```typescript
// amplify/data/resource.ts

const data = defineData({
  routes: {
    conversation: {
      model: 'claude-3-5-sonnet-20241022',
      systemPrompt: '...',

      // Reference SAM-deployed Knowledge Base
      retrieveAndGenerateConfiguration: {
        type: 'KNOWLEDGE_BASE',
        knowledgeBaseConfiguration: {
          knowledgeBaseId: process.env.BEDROCK_KB_ID,
          // From SAM CloudFormation outputs
        }
      },

      tools: [extractSourcesTool],
    }
  }
});

// Custom handler calls existing QueryKB Lambda if needed
// (optional - can also call Bedrock directly via Amplify)
```

## Cost Model

### SAM Stack Costs (Always)
- Lambda invocations (ProcessDoc, GenerateEmbed, QueryKB)
- Bedrock tokens (OCR, embeddings, search queries)
- S3 storage + requests
- DynamoDB (DocumentTable)
- EventBridge + Step Functions

**Estimated**: $80-150/month (document-dependent)

### Amplify Stack Costs (Optional - If Deployed)
- AppSync ($4/million query operations)
- Lambda (chat handler) - usually within free tier
- DynamoDB (ConversationTable, on-demand)
- Negligible if light usage

**Estimated**: +$0-50/month (usage-dependent)

### Removing Chat (To Save Costs)
```bash
cd amplify/
amplify delete
# SAM stack continues working
# Search feature unaffected
# Saves chat infrastructure costs
```

## Environment Variables & Configuration

### For SAM Deployment
```bash
# Standard deployment params
--project-name myapp
--admin-email user@example.com
--region us-east-1
```

### For Amplify Chat Deployment
```bash
# Required from SAM outputs
export BEDROCK_KB_ID="A1B2C3D4"
export QUERY_KB_LAMBDA_ARN="arn:aws:lambda:..."

# Optional: if customizing chat
export ENABLE_CHAT="true"
export CHAT_MODEL="claude-3-5-sonnet-20241022"
```

## Frontend Integration

### React UI with Both Features

```jsx
// src/ui/src/App.jsx
import { useEffect, useState } from 'react';
import SearchTab from './components/Search';
import ChatTab from './components/Chat';

export function App() {
  const [chatEnabled, setChatEnabled] = useState(false);

  useEffect(() => {
    // Detect if Amplify stack deployed
    const checkAmplify = async () => {
      try {
        const response = await fetch('/.amplify/outputs.json');
        setChatEnabled(response.ok);
      } catch {
        setChatEnabled(false);
      }
    };
    checkAmplify();
  }, []);

  return (
    <div>
      <SearchTab /> {/* Always available */}
      {chatEnabled && <ChatTab />} {/* Only if Amplify deployed */}
    </div>
  );
}
```

## Troubleshooting Cross-Stack Issues

### Chat Can't Find QueryKB Lambda
- Check `QUERY_KB_LAMBDA_ARN` environment variable is set
- Verify SAM stack deployed successfully
- Check IAM permissions for chat Lambda to invoke QueryKB

### Chat Can't Access Knowledge Base
- Check `BEDROCK_KB_ID` environment variable is set
- Verify KB exists in Bedrock console
- Check Amplify Lambda has `bedrock:RetrieveAndGenerate` permission

### Both Search and Chat Failing
- Problem likely in core SAM stack or Bedrock KB
- Check ProcessDocument and GenerateEmbeddings Lambdas
- Verify Bedrock models are enabled in account

## Summary

- **SAM stack**: Document pipeline + search (always)
- **Amplify stack**: Chat interface (optional, separate)
- **Shared**: Bedrock Knowledge Base, Cognito auth
- **Independent**: Each stack can be deployed/updated/deleted alone
- **Cost**: Pay only for what you use
