#!/usr/bin/env node

/**
 * Inject Amplify Configuration into Web Component Build
 *
 * This script runs before the Vite build to embed:
 * 1. amplify_outputs.json - Amplify API configuration
 * 2. Theme configuration - Fallback defaults (runtime fetch is preferred)
 * 3. Theme API config - SAM stack GraphQL endpoint and API key for runtime theme fetching
 *
 * Theme API config comes from environment variables (set by CodeBuild):
 * - SAM_GRAPHQL_ENDPOINT: SAM stack AppSync GraphQL URL
 * - SAM_GRAPHQL_API_KEY: API key for public theme config access
 *
 * Usage: node scripts/inject-amplify-config.js
 *
 * Reads: ../../../amplify_outputs.json (from repo root)
 * Writes: src/amplify-config.generated.ts (imported by src/wc.ts)
 */

const fs = require('fs');
const path = require('path');

// Paths relative to src/amplify-chat/scripts/
const LOCAL_OUTPUTS_PATH = path.join(__dirname, '../amplify_outputs.json');
const REPO_ROOT_OUTPUTS_PATH = path.join(__dirname, '../../../amplify_outputs.json');
const LOCAL_THEME_PATH = path.join(__dirname, '../theme_config.json');
const REPO_ROOT_THEME_PATH = path.join(__dirname, '../../../theme_config.json');
const GENERATED_CONFIG_PATH = path.join(__dirname, '../src/amplify-config.generated.ts');

/**
 * Get theme configuration from environment variables or file
 */
function getThemeConfig() {
  // Priority 1: Environment variables (set by CodeBuild from DynamoDB)
  if (process.env.CHAT_THEME_PRESET) {
    console.log('‚úì Using theme config from environment variables');
    return {
      themePreset: process.env.CHAT_THEME_PRESET || 'light',
      themeOverrides: {
        primaryColor: process.env.CHAT_PRIMARY_COLOR || undefined,
        fontFamily: process.env.CHAT_FONT_FAMILY || undefined,
        spacing: process.env.CHAT_SPACING || undefined,
      }
    };
  }

  // Priority 2: theme_config.json file
  const themePath = fs.existsSync(LOCAL_THEME_PATH) ? LOCAL_THEME_PATH :
                    fs.existsSync(REPO_ROOT_THEME_PATH) ? REPO_ROOT_THEME_PATH : null;

  if (themePath) {
    try {
      const themeRaw = fs.readFileSync(themePath, 'utf-8');
      const theme = JSON.parse(themeRaw);
      console.log('‚úì Using theme config from:', themePath);
      return theme;
    } catch (e) {
      console.warn('‚ö† Failed to parse theme_config.json:', e.message);
    }
  }

  // Priority 3: Defaults
  console.log('‚úì Using default theme config (light)');
  return {
    themePreset: 'light',
    themeOverrides: {}
  };
}

function main() {
  console.log('üîß Injecting Amplify configuration into web component...');

  // Check if amplify_outputs.json exists (try local first, then repo root)
  let AMPLIFY_OUTPUTS_PATH;
  if (fs.existsSync(LOCAL_OUTPUTS_PATH)) {
    AMPLIFY_OUTPUTS_PATH = LOCAL_OUTPUTS_PATH;
    console.log('‚úì Found amplify_outputs.json at local path:', LOCAL_OUTPUTS_PATH);
  } else if (fs.existsSync(REPO_ROOT_OUTPUTS_PATH)) {
    AMPLIFY_OUTPUTS_PATH = REPO_ROOT_OUTPUTS_PATH;
    console.log('‚úì Found amplify_outputs.json at repo root:', REPO_ROOT_OUTPUTS_PATH);
  } else {
    console.error('‚ùå Error: amplify_outputs.json not found at either:');
    console.error('   Local:', LOCAL_OUTPUTS_PATH);
    console.error('   Repo root:', REPO_ROOT_OUTPUTS_PATH);
    console.error('   Run `npx ampx deploy` first to generate Amplify configuration.');
    process.exit(1);
  }

  try {
    // Read and parse amplify_outputs.json
    const amplifyOutputsRaw = fs.readFileSync(AMPLIFY_OUTPUTS_PATH, 'utf-8');
    const amplifyOutputs = JSON.parse(amplifyOutputsRaw);

    // Get theme configuration (fallback defaults)
    const themeConfig = getThemeConfig();

    // Get theme API configuration for runtime fetching
    const themeApiConfig = {
      endpoint: process.env.SAM_GRAPHQL_ENDPOINT || null,
      apiKey: process.env.SAM_GRAPHQL_API_KEY || null,
    };

    if (themeApiConfig.endpoint && themeApiConfig.apiKey) {
      console.log('‚úì Theme API config found (runtime theme fetching enabled)');
    } else {
      console.log('‚ö† Theme API config not set (will use embedded defaults)');
      console.log('  Set SAM_GRAPHQL_ENDPOINT and SAM_GRAPHQL_API_KEY for runtime fetching');
    }

    // Generate TypeScript config file
    const configContent = `/**
 * Auto-generated Amplify Configuration
 *
 * This file is generated by scripts/inject-amplify-config.js during build.
 * DO NOT EDIT MANUALLY - changes will be overwritten.
 *
 * Generated: ${new Date().toISOString()}
 */

export const AMPLIFY_OUTPUTS = ${JSON.stringify(amplifyOutputs, null, 2)} as const;

/**
 * Theme configuration embedded at build time (fallback defaults)
 *
 * These defaults are used if runtime theme fetching fails.
 * Can be overridden per-instance using attributes on <amplify-chat>.
 */
export const THEME_CONFIG = ${JSON.stringify(themeConfig, null, 2)} as const;

/**
 * SAM Stack GraphQL API configuration for runtime theme fetching
 *
 * If endpoint and apiKey are set, the web component will fetch theme
 * configuration from the SAM stack's AppSync API at runtime.
 * This allows instant theme changes without rebuilding the component.
 */
export const THEME_API_CONFIG = ${JSON.stringify(themeApiConfig, null, 2)} as const;
`;

    // Write config file
    fs.writeFileSync(GENERATED_CONFIG_PATH, configContent, 'utf-8');

    console.log('‚úÖ Configuration injected successfully');
    console.log(`   Amplify API: ${amplifyOutputs.data?.url || 'N/A'}`);
    console.log(`   Region: ${amplifyOutputs.auth?.aws_region || 'N/A'}`);
    console.log(`   Theme API: ${themeApiConfig.endpoint || 'Not configured'}`);
    console.log(`   Fallback Theme: ${themeConfig.themePreset}`);

  } catch (error) {
    console.error('‚ùå Error injecting configuration:', error.message);
    process.exit(1);
  }
}

main();
