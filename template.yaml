AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: RAGStack-Lambda - OCR to Bedrock Knowledge Base Pipeline

Parameters:
  DeploymentSuffix:
    Type: String
    Description: Unique suffix for this deployment (generated by publish.py)
    MinLength: 5
    MaxLength: 5
    AllowedPattern: '^[a-z0-9]{5}$'
    ConstraintDescription: Must be exactly 5 lowercase alphanumeric characters

  ProjectName:
    Type: String
    Description: Project name for resource identification (lowercase alphanumeric + hyphens, 2-32 chars)
    AllowedPattern: '^[a-z][a-z0-9-]{1,31}$'
    ConstraintDescription: Must start with lowercase letter, contain only lowercase alphanumeric and hyphens, 2-32 chars
    MinLength: 2
    MaxLength: 32

  OcrBackend:
    Type: String
    Default: textract
    AllowedValues:
      - textract
      - bedrock
    Description: OCR backend to use (textract or bedrock)

  BedrockOcrModelId:
    Type: String
    Default: anthropic.claude-3-5-haiku-20241022-v1:0
    Description: Bedrock model ID for OCR (if backend=bedrock)
    AllowedValues:
      - anthropic.claude-3-5-haiku-20241022-v1:0
      - anthropic.claude-3-5-sonnet-20241022-v2:0
      - anthropic.claude-3-haiku-20240307-v1:0
      - anthropic.claude-3-sonnet-20240229-v1:0
    ConstraintDescription: Must be a valid Bedrock Claude model ID

  TextEmbedModelId:
    Type: String
    Default: amazon.titan-embed-text-v2:0
    Description: Bedrock model ID for text embeddings
    AllowedValues:
      - amazon.titan-embed-text-v2:0
      - amazon.titan-embed-text-v1
    ConstraintDescription: Must be a valid Bedrock Titan text embedding model ID

  ImageEmbedModelId:
    Type: String
    Default: amazon.titan-embed-image-v1
    Description: Bedrock model ID for image embeddings
    AllowedValues:
      - amazon.titan-embed-image-v1
    ConstraintDescription: Must be a valid Bedrock Titan image embedding model ID

  UISourceBucket:
    Type: String
    Description: S3 bucket containing UI source code zip
    Default: ''

  UISourceKey:
    Type: String
    Description: S3 key for UI source code zip
    Default: ''

  AdminEmail:
    Type: String
    Description: Admin email for Cognito user and CloudWatch/budget alerts
    AllowedPattern: '^[\w.+-]+@([\w-]+\.)+[\w-]{2,6}$'
    ConstraintDescription: Must be a valid email address

Globals:
  Function:
    Runtime: python3.13
    Timeout: 900  # 15 minutes
    MemorySize: 2048
    Environment:
      Variables:
        LOG_LEVEL: INFO

Conditions:
  BuildUI: !Not [!Equals [!Ref UISourceBucket, '']]

Resources:
  # =========================================================================
  # S3 Buckets
  # =========================================================================

  InputBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-input-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupIncompleteUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  OutputBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-output-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldOutputs
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - HEAD
            AllowedOrigins:
              - !Sub 'https://${CloudFrontDistribution.DomainName}'
            MaxAge: 3000
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  WorkingBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-working-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteWorkingFiles
            Status: Enabled
            ExpirationInDays: 7
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  VectorBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-vectors-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldVectors
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  # =========================================================================
  # CodeBuild Resources for UI Deployment
  # =========================================================================

  UICodeBuildServiceRole:
    Type: AWS::IAM::Role
    Condition: BuildUI
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub 'codebuild.${AWS::URLSuffix}'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildUIPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 read access for UI source artifacts
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}'
              # S3 write access for UI deployment bucket
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub '${UIBucket.Arn}'
                  - !Sub '${UIBucket.Arn}/*'
              # CloudFront invalidation
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                Resource: !Sub 'arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'
              # CloudFormation read access for outputs
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                Resource: !Ref AWS::StackId
              # EventBridge rule creation
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:PutTargets
                  - events:RemoveTargets
                  - events:DeleteRule
                Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*'
              # Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  UICodeBuildProject:
    Type: AWS::CodeBuild::Project
    Condition: BuildUI
    Properties:
      Name: !Sub '${AWS::StackName}-webui-build'
      Description: !Sub 'Web UI build for RAGStack-Lambda stack - ${AWS::StackName}'
      ServiceRole: !GetAtt UICodeBuildServiceRole.Arn
      EncryptionKey: alias/aws/s3
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: S3
        Location: !Sub '${UISourceBucket}/${UISourceKey}'
        BuildSpec: |
          version: 0.2
          phases:
            pre_build:
              commands:
                - echo "Installing dependencies..."
                - cd src/ui
                - npm install
            build:
              commands:
                - echo "Building React application..."
                - |
                  # Generate aws-exports.js from CloudFormation outputs
                  cat > src/aws-exports.js << EOF
                  const awsConfig = {
                    region: '${AWS_REGION}',
                    userPoolId: '${USER_POOL_ID}',
                    userPoolWebClientId: '${USER_POOL_CLIENT_ID}',
                    identityPoolId: '${IDENTITY_POOL_ID}',
                    apiEndpoint: '${GRAPHQL_API_URL}',
                  };
                  export default awsConfig;
                  EOF
                - npm run build
            post_build:
              commands:
                - echo "Deploying to S3..."
                - aws s3 sync build/ s3://${UI_BUCKET}/ --delete
                - echo "Invalidating CloudFront cache..."
                - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DIST_ID} --paths "/*"
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
          - Name: AWS_REGION
            Value: !Ref AWS::Region
          - Name: USER_POOL_ID
            Value: !Ref UserPool
          - Name: USER_POOL_CLIENT_ID
            Value: !Ref UserPoolClient
          - Name: IDENTITY_POOL_ID
            Value: !Ref IdentityPool
          - Name: GRAPHQL_API_URL
            Value: !GetAtt GraphQLApi.GraphQLUrl
          - Name: UI_BUCKET
            Value: !Ref UIBucket
          - Name: CLOUDFRONT_DIST_ID
            Value: !Ref CloudFrontDistribution
      TimeoutInMinutes: 30

  # =========================================================================
  # UI S3 Bucket
  # =========================================================================

  UIBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-ui-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: false  # CloudFront needs access
        IgnorePublicAcls: true
        RestrictPublicBuckets: false
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  # =========================================================================
  # CloudFront Distribution for UI
  # =========================================================================

  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub 'OAI for ${ProjectName} UI'

  UIBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref UIBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub '${UIBucket.Arn}/*'

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub '${ProjectName} UI Distribution'
        DefaultRootObject: index.html
        HttpVersion: http2
        PriceClass: PriceClass_100  # Use only North America and Europe

        Origins:
          - Id: S3Origin
            DomainName: !GetAtt UIBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}'

        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none

        # Custom error pages for SPA routing
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300

        ViewerCertificate:
          CloudFrontDefaultCertificate: true
          # For custom domain, use ACM certificate:
          # AcmCertificateArn: !Ref CertificateArn
          # SslSupportMethod: sni-only
          # MinimumProtocolVersion: TLSv1.2_2021

  # =========================================================================
  # DynamoDB Tables
  # =========================================================================

  TrackingTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      TableName: !Sub '${ProjectName}-tracking-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: document_id
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: document_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CreatedAtIndex
          KeySchema:
            - AttributeName: created_at
              KeyType: HASH
            - AttributeName: document_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  MeteringTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      TableName: !Sub '${ProjectName}-metering-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: document_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: document_id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      TimeToLiveSpecification:
        Enabled: true
        AttributeName: ttl
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  ##########################################################################
  # Configuration Table - Runtime configurable parameters
  ##########################################################################

  ConfigurationTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub '${ProjectName}-config-${DeploymentSuffix}'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: Configuration
          AttributeType: S
      KeySchema:
        - AttributeName: Configuration
          KeyType: HASH
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: Runtime Configuration Storage

  # =========================================================================
  # Lambda Layers
  # =========================================================================

  RagstackCommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub 'RAGStack-${ProjectName}-Common'
      Description: Shared utilities for RAGStack Lambda functions
      ContentUri: lib/
      CompatibleRuntimes:
        - python3.13

  # =========================================================================
  # Lambda Functions
  # =========================================================================

  ProcessDocumentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-process-${DeploymentSuffix}'
      CodeUri: src/lambda/process_document/
      Handler: index.lambda_handler
      Description: Process document - OCR and text extraction
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 900  # 15 minutes for large documents
      MemorySize: 3008  # Max memory for OCR processing
      Tracing: Active
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt ProcessingDLQ.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          TRACKING_TABLE: !Ref TrackingTable
          METERING_TABLE: !Ref MeteringTable
          OUTPUT_BUCKET: !Ref OutputBucket
          WORKING_BUCKET: !Ref WorkingBucket
          OCR_BACKEND: !Ref OcrBackend
          BEDROCK_OCR_MODEL_ID: !Ref BedrockOcrModelId
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3CrudPolicy:
            BucketName: !Ref WorkingBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MeteringTable
        - DynamoDBReadPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
            - Effect: Allow
              Action:
                - textract:DetectDocumentText
                - textract:AnalyzeDocument
              Resource: '*'
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/*'
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'

  GenerateEmbeddingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-embed-${DeploymentSuffix}'
      CodeUri: src/lambda/generate_embeddings/
      Handler: index.lambda_handler
      Description: Generate text and image embeddings
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 900
      MemorySize: 2048
      Tracing: Active
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt ProcessingDLQ.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          TRACKING_TABLE: !Ref TrackingTable
          METERING_TABLE: !Ref MeteringTable
          VECTOR_BUCKET: !Ref VectorBucket
          TEXT_EMBED_MODEL: !Ref TextEmbedModelId
          IMAGE_EMBED_MODEL: !Ref ImageEmbedModelId
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref OutputBucket
        - S3CrudPolicy:
            BucketName: !Ref VectorBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MeteringTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/*'
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'

  QueryKBFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-query-${DeploymentSuffix}'
      CodeUri: src/lambda/query_kb/
      Handler: index.lambda_handler
      Description: Query Bedrock Knowledge Base
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 60
      MemorySize: 512
      Tracing: Active
      Environment:
        Variables:
          LOG_LEVEL: INFO
          KNOWLEDGE_BASE_ID: !GetAtt KnowledgeBase.KnowledgeBaseId
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:RetrieveAndGenerate
              Resource: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/*'
                - !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*'

  ##########################################################################
  # Configuration Resolver Lambda
  ##########################################################################

  ConfigurationResolverFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-config-${DeploymentSuffix}'
      CodeUri: src/lambda/configuration_resolver/
      Handler: index.lambda_handler
      Description: GraphQL resolver for configuration management
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
          TRACKING_TABLE: !Ref TrackingTable
          STATE_MACHINE_ARN: !Ref ProcessingStateMachine
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource: !GetAtt ConfigurationTable.Arn
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:Query
              Resource:
                - !GetAtt TrackingTable.Arn
                - !Sub '${TrackingTable.Arn}/index/StatusIndex'
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref ProcessingStateMachine

  # =========================================================================
  # Step Functions State Machine
  # =========================================================================

  StateMachineExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambdas
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt ProcessDocumentFunction.Arn
                  - !GetAtt GenerateEmbeddingsFunction.Arn
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutLogEvents
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: '*'

  ProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub 'RAGStack-${ProjectName}-ProcessingPipeline'
      DefinitionUri: src/statemachine/pipeline.asl.json
      DefinitionSubstitutions:
        ProcessDocumentFunctionArn: !GetAtt ProcessDocumentFunction.Arn
        GenerateEmbeddingsFunctionArn: !GetAtt GenerateEmbeddingsFunction.Arn
      Role: !GetAtt StateMachineExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogGroup.Arn

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vendedlogs/states/${ProjectName}-Pipeline'
      RetentionInDays: 30

  # =========================================================================
  # EventBridge Rule for S3 Upload Trigger
  # =========================================================================

  S3UploadRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub 'RAGStack-${ProjectName}-S3UploadTrigger'
      Description: Trigger processing pipeline on S3 upload
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        detail:
          bucket:
            name:
              - !Ref InputBucket
      State: ENABLED
      Targets:
        - Arn: !GetAtt ProcessingStateMachine.Arn
          RoleArn: !GetAtt EventBridgeToStepFunctionsRole.Arn
          Id: TriggerProcessing
          InputTransformer:
            InputPathsMap:
              bucket: $.detail.bucket.name
              key: $.detail.object.key
            InputTemplate: !Sub |
              {
                "document_id": "<key>",
                "input_s3_uri": "s3://<bucket>/<key>",
                "output_s3_prefix": "s3://${OutputBucket}/<key>/",
                "vector_bucket": "${VectorBucket}"
              }
          RetryPolicy:
            MaximumRetryAttempts: 2

  EventBridgeToStepFunctionsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StartExecution
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource: !GetAtt ProcessingStateMachine.Arn

  # =========================================================================
  # Bedrock Knowledge Base
  # =========================================================================

  KnowledgeBaseRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                'aws:SourceAccount': !Ref AWS::AccountId
              ArnLike:
                'aws:SourceArn': !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
      Policies:
        - PolicyName: S3VectorsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${VectorBucket.Arn}'
                  - !Sub '${VectorBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3vectors:DescribeIndex
                  - s3vectors:ReadVectors
                  - s3vectors:WriteVectors
                  - s3vectors:PutVectors
                  - s3vectors:QueryVectors
                  - s3vectors:GetVectors
                  - s3vectors:DeleteVectors
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}'
                  - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}/*'
        - PolicyName: BedrockModelAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/${TextEmbedModelId}'

  KnowledgeBaseCustomResourceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-kb-init-${DeploymentSuffix}'
      CodeUri: src/lambda/kb_custom_resource/
      Handler: index.lambda_handler
      Description: Custom resource for Knowledge Base creation with S3 Vectors
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:CreateKnowledgeBase
                - bedrock:DeleteKnowledgeBase
                - bedrock:GetKnowledgeBase
                - bedrock:UpdateKnowledgeBase
                - bedrock:ListKnowledgeBases
                - bedrock:CreateDataSource
                - bedrock:DeleteDataSource
                - bedrock:GetDataSource
                - bedrock:ListDataSources
              Resource: '*'
            - Effect: Allow
              Action:
                - s3vectors:CreateVectorBucket
                - s3vectors:GetVectorBucket
                - s3vectors:CreateIndex
                - s3vectors:DeleteIndex
                - s3vectors:DescribeIndex
                - s3vectors:ListIndices
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}'
                - !Sub 'arn:${AWS::Partition}:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/${VectorBucket}/*'
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt KnowledgeBaseRole.Arn
            - Effect: Allow
              Action:
                - ssm:PutParameter
                - ssm:DeleteParameter
                - ssm:GetParameter
              Resource: !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/KnowledgeBaseId'

  KnowledgeBase:
    Type: Custom::KnowledgeBase
    Properties:
      ServiceToken: !GetAtt KnowledgeBaseCustomResourceFunction.Arn
      KnowledgeBaseName: !Sub '${ProjectName}-kb-${DeploymentSuffix}'
      RoleArn: !GetAtt KnowledgeBaseRole.Arn
      VectorBucket: !Ref VectorBucket
      EmbedModelArn: !Sub 'arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/${TextEmbedModelId}'
      IndexName: !Sub '${ProjectName}-index-${DeploymentSuffix}'
      Region: !Ref AWS::Region
      ProjectName: !Ref ProjectName

  # =========================================================================
  # Cognito Authentication
  # =========================================================================

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub 'RAGStack-${ProjectName}-Users'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub 'RAGStack-${ProjectName}-WebClient'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub 'RAGStack${ProjectName}Identity'
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      Policies:
        - PolicyName: AuthenticatedAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource:
                  - !Sub '${InputBucket.Arn}/*'
                  - !Sub '${OutputBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - appsync:GraphQL
                Resource:
                  - !Sub '${GraphQLApi.Arn}/*'

  AdminUser:
    Type: AWS::Cognito::UserPoolUser
    Properties:
      UserPoolId: !Ref UserPool
      Username: !Ref AdminEmail
      UserAttributes:
        - Name: email
          Value: !Ref AdminEmail
        - Name: email_verified
          Value: 'true'
      DesiredDeliveryMediums:
        - EMAIL

  # =========================================================================
  # AppSync GraphQL API
  # =========================================================================

  GraphQLApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub 'RAGStack-${ProjectName}-API'
      AuthenticationType: AMAZON_COGNITO_USER_POOLS
      UserPoolConfig:
        UserPoolId: !Ref UserPool
        AwsRegion: !Ref AWS::Region
        DefaultAction: ALLOW
      LogConfig:
        CloudWatchLogsRoleArn: !GetAtt AppSyncLogsRole.Arn
        FieldLogLevel: ERROR

  GraphQLSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      DefinitionS3Location: ./src/api/schema.graphql

  AppSyncLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs

  # AppSync resolver Lambda
  AppSyncResolverFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-appsync-${DeploymentSuffix}'
      CodeUri: src/lambda/appsync_resolvers/
      Handler: index.lambda_handler
      Layers:
        - !Ref RagstackCommonLayer
      Tracing: Active
      Environment:
        Variables:
          TRACKING_TABLE: !Ref TrackingTable
          INPUT_BUCKET: !Ref InputBucket
          STATE_MACHINE_ARN: !GetAtt ProcessingStateMachine.Arn
      Tags:
        Project: !Ref ProjectName
        CostCenter: Engineering
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3CrudPolicy:
            BucketName: !Ref InputBucket
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !GetAtt ProcessingStateMachine.Arn

  StartUICodeBuild:
    Type: AWS::Serverless::Function
    Condition: BuildUI
    Properties:
      FunctionName: !Sub '${ProjectName}-ui-builder-${DeploymentSuffix}'
      CodeUri: src/lambda/start_codebuild/
      Handler: index.lambda_handler
      Description: Custom resource to trigger UI CodeBuild project
      Layers:
        - !Ref RagstackCommonLayer
      Runtime: python3.13
      Timeout: 300  # 5 minutes
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - codebuild:StartBuild
                - codebuild:BatchGetBuilds
              Resource: !GetAtt UICodeBuildProject.Arn
        - Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:DeleteRule
                - events:PutTargets
                - events:RemoveTargets
              Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  CodeBuildRun:
    Type: Custom::CodeBuildRun
    Condition: BuildUI
    Properties:
      ServiceToken: !GetAtt StartUICodeBuild.Arn
      BuildProjectName: !Ref UICodeBuildProject
      # Force rebuild when source changes
      UISourceLocation: !Sub 's3://${UISourceBucket}/${UISourceKey}'

  # Data source for resolvers
  AppSyncLambdaDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: LambdaDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AppSyncResolverFunction.Arn

  AppSyncLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambda
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt AppSyncResolverFunction.Arn
                  - !GetAtt QueryKBFunction.Arn
                  - !GetAtt ConfigurationResolverFunction.Arn

  # Data source for KB queries
  KBQueryDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: KBQueryDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt QueryKBFunction.Arn

  # Data source for Configuration Resolver
  ConfigurationResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: ConfigurationResolverDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ConfigurationResolverFunction.Arn

  # Resolvers
  GetDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getDocument
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  ListDocumentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: listDocuments
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  CreateUploadUrlResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: createUploadUrl
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  ProcessDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: processDocument
      DataSourceName: !GetAtt AppSyncLambdaDataSource.Name

  QueryKBResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: queryKnowledgeBase
      DataSourceName: !GetAtt KBQueryDataSource.Name

  # Configuration Resolvers
  GetConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getConfiguration
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  UpdateConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: updateConfiguration
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  GetDocumentCountResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getDocumentCount
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  GetReEmbedJobStatusResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Query
      FieldName: getReEmbedJobStatus
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  ReEmbedAllDocumentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      TypeName: Mutation
      FieldName: reEmbedAllDocuments
      DataSourceName: !GetAtt ConfigurationResolverDataSource.Name

  # =========================================================================
  # Dead Letter Queue for Error Handling
  # =========================================================================

  ProcessingDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'RAGStack-${ProjectName}-Processing-DLQ'
      MessageRetentionPeriod: 1209600  # 14 days
      VisibilityTimeout: 300
      SqsManagedSseEnabled: true

  # =========================================================================
  # SNS Topic for Alarm Notifications
  # =========================================================================

  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'RAGStack-${ProjectName}-Alarms'
      DisplayName: !Sub 'RAGStack-${ProjectName} CloudWatch Alarms'
      KmsMasterKeyId: alias/aws/sns
      Subscription:
        - Endpoint: !Ref AdminEmail
          Protocol: email

  # =========================================================================
  # CloudWatch Dashboard
  # =========================================================================

  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub 'RAGStack-${ProjectName}-Monitor'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "ProcessDocument", "color": "#1f77b4"}],
                  ["...", {"stat": "Sum", "label": "GenerateEmbeddings", "color": "#ff7f0e"}],
                  ["...", {"stat": "Sum", "label": "QueryKB", "color": "#2ca02c"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Invocations",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", {"stat": "Sum", "label": "ProcessDocument Errors", "color": "#d62728"}],
                  ["...", {"stat": "Sum", "label": "GenerateEmbeddings Errors", "color": "#ff7f0e"}],
                  ["...", {"stat": "Sum", "label": "QueryKB Errors", "color": "#e377c2"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Errors",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/States", "ExecutionsFailed", {"stat": "Sum", "color": "#d62728"}],
                  [".", "ExecutionsSucceeded", {"stat": "Sum", "color": "#2ca02c"}],
                  [".", "ExecutionsTimedOut", {"stat": "Sum", "color": "#ff7f0e"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Step Functions Executions"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", {"label": "DLQ Messages", "color": "#d62728"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Dead Letter Queue",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum", "color": "#1f77b4"}],
                  [".", "ConsumedWriteCapacityUnits", {"stat": "Sum", "color": "#ff7f0e"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Capacity"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", {"stat": "Average", "label": "ProcessDocument", "color": "#1f77b4"}],
                  ["...", {"stat": "Average", "label": "GenerateEmbeddings", "color": "#ff7f0e"}],
                  ["...", {"stat": "Average", "label": "QueryKB", "color": "#2ca02c"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Duration (ms)",
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            }
          ]
        }

  # =========================================================================
  # CloudWatch Alarms
  # =========================================================================

  ProcessDocumentErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'RAGStack-${ProjectName}-ProcessDocument-Errors'
      AlarmDescription: Alert when ProcessDocument Lambda has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessDocumentFunction
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  GenerateEmbeddingsErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'RAGStack-${ProjectName}-GenerateEmbeddings-Errors'
      AlarmDescription: Alert when GenerateEmbeddings Lambda has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref GenerateEmbeddingsFunction
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  DLQMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'RAGStack-${ProjectName}-DLQ-Messages'
      AlarmDescription: Alert when messages appear in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt ProcessingDLQ.QueueName
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  StepFunctionsFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'RAGStack-${ProjectName}-StepFunctions-Failures'
      AlarmDescription: Alert when Step Functions executions fail
      MetricName: ExecutionsFailed
      Namespace: AWS/States
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref ProcessingStateMachine
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  ProcessDocumentThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'RAGStack-${ProjectName}-ProcessDocument-Throttles'
      AlarmDescription: Alert when ProcessDocument Lambda is throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessDocumentFunction
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlarmTopic
      OKActions:
        - !Ref AlarmTopic

  # =========================================================================
  # CloudTrail for Audit Logging
  # =========================================================================

  CloudTrailBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub '${ProjectName}-cloudtrail-${DeploymentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: Engineering

  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailBucket.Arn}/*'
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

  CloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: CloudTrailBucketPolicy
    Properties:
      TrailName: !Sub 'RAGStack-${ProjectName}-Trail'
      S3BucketName: !Ref CloudTrailBucket
      IsLogging: true
      IsMultiRegionTrail: false
      IncludeGlobalServiceEvents: true
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
          DataResources:
            - Type: AWS::S3::Object
              Values:
                - !Sub '${InputBucket.Arn}/*'
                - !Sub '${OutputBucket.Arn}/*'
                - !Sub '${VectorBucket.Arn}/*'
            - Type: AWS::Lambda::Function
              Values:
                - !GetAtt ProcessDocumentFunction.Arn
                - !GetAtt GenerateEmbeddingsFunction.Arn

  # =========================================================================
  # Cost Management - Monthly Budget
  # =========================================================================

  MonthlyBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub 'RAGStack-${ProjectName}-Monthly-Budget'
        BudgetLimit:
          Amount: 100
          Unit: USD
        TimeUnit: MONTHLY
        BudgetType: COST
        CostFilters:
          TagKeyValue:
            - !Sub 'user:Project$${ProjectName}'
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 80
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref AdminEmail
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 100
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref AdminEmail

Outputs:
  # S3 Buckets
  InputBucketName:
    Description: S3 bucket for document uploads
    Value: !Ref InputBucket
    Export:
      Name: !Sub '${AWS::StackName}-InputBucket'

  OutputBucketName:
    Description: S3 bucket for processed documents
    Value: !Ref OutputBucket
    Export:
      Name: !Sub '${AWS::StackName}-OutputBucket'

  WorkingBucketName:
    Description: S3 bucket for temporary working files
    Value: !Ref WorkingBucket
    Export:
      Name: !Sub '${AWS::StackName}-WorkingBucket'

  VectorBucketName:
    Description: S3 bucket for embeddings and vectors
    Value: !Ref VectorBucket
    Export:
      Name: !Sub '${AWS::StackName}-VectorBucket'

  UIBucketName:
    Description: S3 bucket for WebUI hosting
    Value: !Ref UIBucket
    Export:
      Name: !Sub '${AWS::StackName}-UIBucket'

  # DynamoDB Tables
  TrackingTableName:
    Description: DynamoDB table for document tracking
    Value: !Ref TrackingTable
    Export:
      Name: !Sub '${AWS::StackName}-TrackingTable'

  MeteringTableName:
    Description: DynamoDB table for usage metering
    Value: !Ref MeteringTable
    Export:
      Name: !Sub '${AWS::StackName}-MeteringTable'

  ConfigurationTableName:
    Description: Configuration DynamoDB Table Name
    Value: !Ref ConfigurationTable
    Export:
      Name: !Sub '${AWS::StackName}-ConfigurationTable'

  ConfigurationTableArn:
    Description: Configuration DynamoDB Table ARN
    Value: !GetAtt ConfigurationTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ConfigurationTableArn'

  # Lambda Functions
  ProcessDocumentFunctionArn:
    Description: Process document Lambda ARN
    Value: !GetAtt ProcessDocumentFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ProcessDocumentFunction'

  GenerateEmbeddingsFunctionArn:
    Description: Generate embeddings Lambda ARN
    Value: !GetAtt GenerateEmbeddingsFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-GenerateEmbeddingsFunction'

  QueryKBFunctionArn:
    Description: Query Knowledge Base Lambda ARN
    Value: !GetAtt QueryKBFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-QueryKBFunction'

  # Step Functions
  StateMachineArn:
    Description: Step Functions state machine ARN
    Value: !GetAtt ProcessingStateMachine.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StateMachine'

  # Knowledge Base
  KnowledgeBaseId:
    Description: Bedrock Knowledge Base ID
    Value: !GetAtt KnowledgeBase.KnowledgeBaseId
    Export:
      Name: !Sub '${AWS::StackName}-KnowledgeBaseId'

  KnowledgeBaseArn:
    Description: Bedrock Knowledge Base ARN
    Value: !GetAtt KnowledgeBase.KnowledgeBaseArn
    Export:
      Name: !Sub '${AWS::StackName}-KnowledgeBaseArn'

  DataSourceId:
    Description: Bedrock Knowledge Base Data Source ID
    Value: !GetAtt KnowledgeBase.DataSourceId
    Export:
      Name: !Sub '${AWS::StackName}-DataSourceId'

  # API & Authentication
  GraphQLApiUrl:
    Description: GraphQL API URL
    Value: !GetAtt GraphQLApi.GraphQLUrl
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLApiUrl'

  GraphQLApiId:
    Description: GraphQL API ID
    Value: !GetAtt GraphQLApi.ApiId
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLApiId'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolId'

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolClientId'

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref IdentityPool
    Export:
      Name: !Sub '${AWS::StackName}-IdentityPoolId'

  # Configuration
  Region:
    Description: AWS Region
    Value: !Ref AWS::Region

  StackName:
    Description: CloudFormation Stack Name
    Value: !Ref AWS::StackName

  # CloudFront
  CloudFrontDomain:
    Description: CloudFront distribution domain
    Value: !GetAtt CloudFrontDistribution.DomainName

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref CloudFrontDistribution

  UIUrl:
    Description: UI URL (HTTPS via CloudFront)
    Value: !Sub 'https://${CloudFrontDistribution.DomainName}'
