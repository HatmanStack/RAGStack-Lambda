name: CI

on: push

jobs:
  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh && echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: uv pip install --system -r requirements.txt

      - name: Lint backend (ruff)
        run: uv run ruff check . && uv run ruff format . --check

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Node dependencies
        run: |
          npm install --legacy-peer-deps
          cd src/ui && npm install --legacy-peer-deps

      - name: Lint frontend (ESLint)
        run: cd src/ui && npm run lint

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Node dependencies
        run: |
          npm install --legacy-peer-deps
          cd src/amplify-chat && npm install --legacy-peer-deps && cd ../..
          cd amplify && npm install --legacy-peer-deps

      - name: Setup generated config for CI
        run: cp src/amplify-chat/src/amplify-config.template.ts src/amplify-chat/src/amplify-config.generated.ts

      - name: Typecheck amplify-chat
        run: cd src/amplify-chat && npx tsc --noEmit

      - name: Typecheck amplify backend
        run: cd amplify && npx tsc --noEmit

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh && echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: uv pip install --system -r requirements.txt

      - name: Test backend (pytest)
        run: uv run pytest tests/unit/python/ -m 'not integration'

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Node dependencies
        run: |
          npm install --legacy-peer-deps
          cd src/ui && npm install --legacy-peer-deps

      - name: Test frontend (vitest)
        run: cd src/ui && npm test -- --run

  test-amplify-chat:
    name: Test Amplify Chat
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Node dependencies
        run: |
          npm install --legacy-peer-deps
          cd src/amplify-chat && npm install --legacy-peer-deps

      - name: Setup generated config for CI
        run: cp src/amplify-chat/src/amplify-config.template.ts src/amplify-chat/src/amplify-config.generated.ts

      - name: Test amplify-chat (vitest)
        run: cd src/amplify-chat && npm test -- --run

  test-amplify-backend:
    name: Test Amplify Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Node dependencies
        run: |
          npm install --legacy-peer-deps
          cd amplify && npm install --legacy-peer-deps

      - name: Test amplify backend (vitest)
        run: cd amplify && npm test -- --run
